
stages:
  - deploy
  - deploy_aas

variables:
  DATADOG_AGENT_WINBUILDIMAGES: v5996510-a9e6a7d
  GIT_PROFILER_REF: master
  DEPLOY_TO_REL_ENV:
    value: "false"
    description: "Set to true to override rules in the reliability-env pipeline (e.g. override 'only deploy master')"
  DEPLOY_TO_AAS:
    value: "false"

deploy_to_reliability_env:
  stage: deploy
  rules:
    - if: '$DEPLOY_TO_REL_ENV == "true"'
  trigger:
    project: DataDog/apm-reliability/datadog-reliability-env
    branch: master
  variables:
    UPSTREAM_PACKAGE_JOB: build
    UPSTREAM_PROJECT_NAME: $CI_PROJECT_NAME
    FORCE_TRIGGER: $DEPLOY_TO_REL_ENV

deploy_to_aas:
  stage: deploy_aas
  tags: ["runner:windows-docker", "windowsversion:1809"]
  rules:
    - if: '$DEPLOY_TO_AAS == "true"'
  script:
    - $result = aws sts assume-role --role-arn "arn:aws:iam::486234852809:role/ci-dd-trace-dotnet" --role-session-name AWSCLI-Session
    - $resultjson = $result | convertfrom-json
    - $credentials = $($resultjson.Credentials)
    - $Env:AWS_ACCESS_KEY_ID="$($credentials.AccessKeyId)"
    - $Env:AWS_SECRET_ACCESS_KEY="$($credentials.SecretAccessKey)"
    - $Env:AWS_SESSION_TOKEN="$($credentials.SessionToken)"
    - $GH_TOKEN_PIERO = aws ssm get-parameter --region us-east-1 --name ci.dd-trace-dotnet.gh_token_piero --with-decryption --query "Parameter.Value" --out text
    - |
      curl -X POST \
      -H "Accept: application/vnd.github.v3+json" \
      -H "Authorization: Bearer $GH_TOKEN_PIERO" \
      https://api.github.com/repos/DataDog/datadog-aas-extension/dispatches \
      -d '{"event_type": "dd-trace-dotnet-nightly", "client_payload": {"sha":"${CI_COMMIT_SHA}" } }'
