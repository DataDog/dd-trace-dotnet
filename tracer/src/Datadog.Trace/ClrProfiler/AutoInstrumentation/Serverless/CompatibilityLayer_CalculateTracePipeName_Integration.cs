// <copyright file="CompatibilityLayer_CalculateTracePipeName_Integration.cs" company="Datadog">
// Unless explicitly stated otherwise all files in this repository are licensed under the Apache 2 License.
// This product includes software developed at Datadog (https://www.datadoghq.com/). Copyright 2017 Datadog, Inc.
// </copyright>

#if NETCOREAPP
using System;
using System.ComponentModel;
using Datadog.Trace.ClrProfiler.CallTarget;
using Datadog.Trace.Configuration;

namespace Datadog.Trace.ClrProfiler.AutoInstrumentation.Serverless
{
    /// <summary>
    /// Instrumentation for Datadog.Serverless.CompatibilityLayer.CalculateTracePipeName method.
    /// This instrumentation overrides the return value with the tracer's pre-generated pipe name,
    /// ensuring both the tracer and the compat layer use the same pipe name for communication.
    /// </summary>
    [InstrumentMethod(
        AssemblyName = "Datadog.Serverless.Compat",
        TypeName = "Datadog.Serverless.CompatibilityLayer",
        MethodName = "CalculateTracePipeName",
        ReturnTypeName = ClrNames.String,
        ParameterTypeNames = new string[0],
        MinimumVersion = "1.0.0",
        MaximumVersion = "2.*.*",
        IntegrationName = nameof(IntegrationId.ServerlessCompat),
        InstrumentationCategory = InstrumentationCategory.Tracing)]
    [Browsable(false)]
    [EditorBrowsable(EditorBrowsableState.Never)]
    public sealed class CompatibilityLayer_CalculateTracePipeName_Integration
    {
        private static readonly object _lock = new object();
        private static string? _cachedTracePipeName;

        /// <summary>
        /// OnMethodEnd callback - intercepts the return value and overrides it with a lazily-generated unique pipe name
        /// </summary>
        /// <typeparam name="TTarget">Type of the target</typeparam>
        /// <param name="instance">Instance value, aka `this` of the instrumented method (null for static methods)</param>
        /// <param name="returnValue">The pipe name calculated by the compat layer</param>
        /// <param name="exception">Exception instance in case the original code threw an exception</param>
        /// <param name="state">Calltarget state value</param>
        /// <returns>A unique pipe name for coordination between tracer and compat layer</returns>
        internal static CallTargetReturn<string> OnMethodEnd<TTarget>(
            TTarget instance,
            string returnValue,
            Exception exception,
            in CallTargetState state)
        {
            if (exception != null)
            {
                // If there was an exception, pass it through
                return new CallTargetReturn<string>(returnValue);
            }

            try
            {
                // Get the tracer's pipe name (generated in ExporterSettings if on Windows with no explicit config)
                // Use lazy caching to avoid repeated lookups
                if (_cachedTracePipeName == null)
                {
                    lock (_lock)
                    {
                        if (_cachedTracePipeName == null)
                        {
                            // Use the pipe name pre-generated by ExporterSettings if available (Azure Functions scenario)
                            // Otherwise, generate a unique pipe name as fallback
                            _cachedTracePipeName = ExporterSettings.AzureFunctionsGeneratedTracesPipeName
                                ?? ServerlessCompatPipeNameHelper.GenerateUniquePipeName(
                                    returnValue,
                                    "dd_trace",
                                    "trace");
                        }
                    }
                }

                Logging.Log.Debug(
                    "ServerlessCompat integration: Overriding compat layer trace pipe name. " +
                    "Compat layer calculated: {CompatPipeName}, Tracer using: {TracerPipeName}",
                    returnValue,
                    _cachedTracePipeName);

                return new CallTargetReturn<string>(_cachedTracePipeName);
            }
            catch (Exception ex)
            {
                Logging.Log.Error(ex, "ServerlessCompat integration: Error overriding trace pipe name");
            }

            // Fallback to compat layer's original value
            return new CallTargetReturn<string>(returnValue);
        }
    }
}
#endif
