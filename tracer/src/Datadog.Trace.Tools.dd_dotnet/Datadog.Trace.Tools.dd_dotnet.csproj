<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <Version>2.38.0</Version>
    <Title>Datadog APM Auto-instrumentation Launcher</Title>
    <Copyright>Copyright 2020 Datadog, Inc.</Copyright>
    <Description>Auto-instrumentation dotnet tool for Datadog APM</Description>
    <OutputType>Exe</OutputType>
    <TargetFrameworks>net7.0</TargetFrameworks>
    <CopyLocalLockFileAssemblies>true</CopyLocalLockFileAssemblies>
    <NoWarn>NU5100</NoWarn>
    <RootNamespace>Datadog.Trace.Tools.dd_dotnet</RootNamespace>
    <AllowUnsafeBlocks>true</AllowUnsafeBlocks>
    <Nullable>enable</Nullable>
    <NoWarn>SA1300</NoWarn>
    <GenerateDocumentationFile>false</GenerateDocumentationFile>

    <AssemblyName>dd-dotnet</AssemblyName>

    <PublishAot>true</PublishAot>
    <OptimizationPreference>Size</OptimizationPreference>
    <EnableUnsafeBinaryFormatterSerialization>false</EnableUnsafeBinaryFormatterSerialization>
    <EnableUnsafeUTF7Encoding>false</EnableUnsafeUTF7Encoding>
    <EventSourceSupport>false</EventSourceSupport>
    <HttpActivityPropagationSupport>false</HttpActivityPropagationSupport>
    <InvariantGlobalization>true</InvariantGlobalization>

    <!--<IlcDisableReflection>true</IlcDisableReflection>-->
    <IlcScanReflection>false</IlcScanReflection>
    <IlcTrimMetadata>true</IlcTrimMetadata>
    <!--<RootAllApplicationAssemblies>false</RootAllApplicationAssemblies>
    <IlcGenerateCompleteTypeMetadata>false</IlcGenerateCompleteTypeMetadata>-->
    <IlcOptimizationPreference>Size</IlcOptimizationPreference>

    <PublishLzmaCompressed>true</PublishLzmaCompressed>    

  </PropertyGroup>

  <ItemGroup>
    <Compile Include="..\Datadog.Trace\Agent\TracesTransportType.cs" Link="TracesTransportType.cs" />
    <Compile Include="..\Datadog.Trace\Configuration\ConfigurationKeys.cs" Link="ConfigurationKeys.cs" />
    <Compile Include="..\Datadog.Trace\Configuration\ConfigurationKeys.Exporter.cs" Link="ConfigurationKeys.Exporter.cs" />
    <Compile Include="..\Datadog.Trace\Configuration\DeprecationMessages.cs" Link="DeprecationMessages.cs" />
    <Compile Include="..\Datadog.Trace\Configuration\ExporterSettings.Shared.cs" Link="ExporterSettings.Shared.cs" />
  </ItemGroup>

  <ItemGroup>
    <PackageReference Include="Microsoft.Win32.Registry" Version="5.0.0" />
    <PackageReference Include="Spectre.Console" Version="0.43.0" />
    <PackageReference Include="System.CommandLine" Version="2.0.0-beta4.22272.1" />
    <PackageReference Include="NETStandard.Library" Version="2.0.3" />
    <PackageReference Include="System.Runtime.InteropServices" Version="4.3.0" />
    <PackageReference Include="PublishAotCompressed" Version="42.42.42-dev" />
    <PackageReference Include="StrongNamer" Version="0.2.5" />
  </ItemGroup>

  <ItemGroup>
    <ProjectReference Include="..\Datadog.Trace.SourceGenerators\Datadog.Trace.SourceGenerators.csproj" OutputItemType="Analyzer" ReferenceOutputAssembly="false" />
  </ItemGroup>

  <Target Name="RemoveDuplicate" AfterTargets="ComputeFilesToPublish" BeforeTargets="_HandleFileConflictsForPublish">

    <!-- Required for StrongNamer: https://github.com/dsplaisted/strongnamer/issues/61 -->
    <Message Text="Removing $(DuplicateFileToRemove) from publish output" Importance="high" />
    <ItemGroup>
      <ResolvedFileToPublish Remove="$(BaseIntermediateOutputPath)$(Configuration)\$(TargetFramework)\$(RuntimeIdentifier)\linked\Spectre.Console.dll" />
      <ResolvedFileToPublish Remove="$(BaseIntermediateOutputPath)$(Configuration)\$(TargetFramework)\$(RuntimeIdentifier)\linked\ILVerification.dll" />
    </ItemGroup>
  </Target>
</Project>
