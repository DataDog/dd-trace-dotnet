// <copyright file="Sources.cs" company="Datadog">
// Unless explicitly stated otherwise all files in this repository are licensed under the Apache 2 License.
// This product includes software developed at Datadog (https://www.datadoghq.com/). Copyright 2017 Datadog, Inc.
// </copyright>

#nullable enable

using System;
using System.Collections.Generic;
using System.Text;
using Datadog.Trace.SourceGenerators.Helpers;

namespace Datadog.Trace.SourceGenerators.TelemetryMetric;

internal partial class Sources
{
    public static string CreateMetricEnumExtension(StringBuilder sb, in TelemetryMetricGenerator.EnumDetails details, Dictionary<string, EquatableArray<string>> enumDictionary)
    {
        return $$"""
            // <auto-generated/>
            #nullable enable

            namespace {{details.Namespace}};
            internal static partial class {{details.ShortName}}Extensions
            {
                /// <summary>
                /// The number of separate metrics in the <see cref="{{details.FullyQualifiedName}}" /> metric.
                /// </summary>
                public const int Length = {{details.Names.Count}};

                /// <summary>
                /// Gets the metric name for the provided metric
                /// </summary>
                /// <param name="metric">The metric to get the name for</param>
                /// <returns>The datadog metric name</returns>
                public static string GetName(this {{details.FullyQualifiedName}} metric)
                    => metric switch
                    {{{GetNames(sb, in details)}}
                        _ => null!,
                    };

                /// <summary>
                /// Gets whether the metric is a "common" metric, used by all tracers
                /// </summary>
                /// <param name="metric">The metric to check</param>
                /// <returns>True if the metric is a "common" metric, used by all languages</returns>
                public static bool IsCommon(this {{details.FullyQualifiedName}} metric)
                    => metric switch
                    {{{GetIsCommon(sb, in details)}}
                        _ => true,
                    };

                /// <summary>
                /// Gets the custom namespace for the provided metric
                /// </summary>
                /// <param name="metric">The metric to get the name for</param>
                /// <returns>The datadog metric name</returns>
                public static string? GetNamespace(this {{details.FullyQualifiedName}} metric)
                    => metric switch
                    {{{GetNamespaces(sb, in details)}}
                        _ => null,
                    };
            }
            """;
    }

    public static string CreateCountTelemetryCollectorPartial(StringBuilder sb, in TelemetryMetricGenerator.EnumDetails details, Dictionary<string, EquatableArray<string>> enumDictionary, int[] metricsToLocation, int[] entryCounts)
    {
        sb.Clear();
        sb.Append(
            """
            // <auto-generated/>
            #nullable enable

            using System.Threading;

            namespace Datadog.Trace.Telemetry;
            internal partial class MetricsTelemetryCollector
            {
                // These can technically overflow, but it's _very_ unlikely as we reset every minute
                // Negative values are normalized during polling
            """);

        if (details.Names.AsArray() is { } names)
        {
            for (var i = 0; i < names.Length; i++)
            {
                sb.AppendLine();
                var (property, metric) = names[i];
                var index = metricsToLocation[i];

                if (metric.Tag2FullyQualifiedName is { } tagName2)
                {
                    var tagName1 = metric.Tag1FullyQualifiedName!;
                    var tag2EntryCount = enumDictionary[tagName2].Count;
                    sb.AppendLine(
                        $$"""
                            public void Record{{details.ShortName}}{{property}}({{tagName1}} tag1, {{tagName2}} tag2, int increment = 1)
                            {
                                var index = {{index}} + ((int)tag1 * {{tag2EntryCount}}) + (int)tag2;
                                Interlocked.Add(ref _buffer.Counts[index].Value, increment);
                            }
                        """);
                }
                else if (metric.Tag1FullyQualifiedName is { } tagName)
                {
                    sb.AppendLine(
                        $$"""
                            public void Record{{details.ShortName}}{{property}}({{tagName}} tag, int increment = 1)
                            {
                                var index = {{index}} + (int)tag;
                                Interlocked.Add(ref _buffer.Counts[index].Value, increment);
                            }
                        """);
                }
                else
                {
                    sb.AppendLine(
                        $$"""
                            public void Record{{details.ShortName}}{{property}}(int increment = 1)
                            {
                                Interlocked.Add(ref _buffer.Counts[{{index}}].Value, increment);
                            }
                        """);
                }
            }
        }

        sb.Append(
            $$"""

                /// <summary>
                /// Creates the buffer for the <see cref="{{details.FullyQualifiedName}}" /> values.
                /// </summary>
                private static MetricKey[] Get{{details.ShortName}}Buffer()
                    => new MetricKey[]
                    {

            """);
        AddMetricKeys(sb, in details, enumDictionary);
        sb.Append(
            $$"""
                    };

                /// <summary>
                /// Gets an array of metric counts, indexed by integer value of the <see cref="{{details.FullyQualifiedName}}" />.
                /// Each value represents the number of unique entries in the buffer returned by <see cref="Get{{details.ShortName}}Buffer()" />
                /// It is equal to the cardinality of the tag combinations (or 1 if there are no tags)
                /// </summary>
                private static int[] {{details.ShortName}}EntryCounts { get; }
                    = new []{ 
            """);

        foreach (var value in entryCounts)
        {
            sb.Append(value).Append(", ");
        }

        sb.AppendLine("};").Append("}");

        return sb.ToString();
    }

    public static string CreateCountITelemetryCollectorPartial(StringBuilder sb, in TelemetryMetricGenerator.EnumDetails details, Dictionary<string, EquatableArray<string>> enumDictionary)
    {
        sb.Clear();
        sb.Append(
            """
            // <auto-generated/>
            #nullable enable

            namespace Datadog.Trace.Telemetry;
            internal partial interface IMetricsTelemetryCollector
            {
            """);

        if (details.Names.AsArray() is { } names)
        {
            for (var i = 0; i < names.Length; i++)
            {
                sb.AppendLine();
                var (property, metric) = names[i];

                if (metric.Tag2FullyQualifiedName is { } tagName2)
                {
                    var tagName1 = metric.Tag1FullyQualifiedName!;
                    sb.AppendLine(
                        $$"""
                            public void Record{{details.ShortName}}{{property}}({{tagName1}} tag1, {{tagName2}} tag2, int increment = 1);
                        """);
                }
                else if (metric.Tag1FullyQualifiedName is { } tagName)
                {
                    sb.AppendLine(
                        $$"""
                            public void Record{{details.ShortName}}{{property}}({{tagName}} tag, int increment = 1);
                        """);
                }
                else
                {
                    sb.AppendLine(
                        $$"""
                            public void Record{{details.ShortName}}{{property}}(int increment = 1);
                        """);
                }
            }
        }

        sb.Append("}");
        return sb.ToString();
    }

    public static string CreateCountNullTelemetryCollectorPartial(StringBuilder sb, in TelemetryMetricGenerator.EnumDetails details, Dictionary<string, EquatableArray<string>> enumDictionary)
    {
        sb.Clear();
        sb.Append(
            """
            // <auto-generated/>
            #nullable enable

            namespace Datadog.Trace.Telemetry;
            internal partial class NullMetricsTelemetryCollector
            {
            """);

        if (details.Names.AsArray() is { } names)
        {
            for (var i = 0; i < names.Length; i++)
            {
                sb.AppendLine();
                var (property, metric) = names[i];

                if (metric.Tag2FullyQualifiedName is { } tagName2)
                {
                    var tagName1 = metric.Tag1FullyQualifiedName!;
                    sb.AppendLine(
                        $$"""
                            public void Record{{details.ShortName}}{{property}}({{tagName1}} tag1, {{tagName2}} tag2, int increment = 1)
                            {
                            }
                        """);
                }
                else if (metric.Tag1FullyQualifiedName is { } tagName)
                {
                    sb.AppendLine(
                        $$"""
                            public void Record{{details.ShortName}}{{property}}({{tagName}} tag, int increment = 1)
                            {
                            }
                        """);
                }
                else
                {
                    sb.AppendLine(
                        $$"""
                            public void Record{{details.ShortName}}{{property}}(int increment = 1)
                            {
                            }
                        """);
                }
            }
        }

        sb.Append("}");
        return sb.ToString();
    }

    public static string CreateGaugeTelemetryCollectorPartial(StringBuilder sb, in TelemetryMetricGenerator.EnumDetails details, Dictionary<string, EquatableArray<string>> enumDictionary, int[] metricsToLocation, int[] entryCounts)
    {
        sb.Clear();
        sb.Append(
            """
            // <auto-generated/>
            #nullable enable

            using System.Threading;

            namespace Datadog.Trace.Telemetry;
            internal partial class MetricsTelemetryCollector
            {
            """);

        if (details.Names.AsArray() is { } names)
        {
            for (var i = 0; i < names.Length; i++)
            {
                sb.AppendLine();
                var (property, metric) = names[i];
                var index = metricsToLocation[i];

                if (metric.Tag2FullyQualifiedName is { } tagName2)
                {
                    var tagName1 = metric.Tag1FullyQualifiedName!;
                    var tag2EntryCount = enumDictionary[tagName2].Count;
                    sb.AppendLine(
                        $$"""
                            public void Record{{details.ShortName}}{{property}}({{tagName1}} tag1, {{tagName2}} tag2, int value)
                            {
                                var index = {{index}} + ((int)tag1 * {{tag2EntryCount}}) + (int)tag2;
                                Interlocked.Exchange(ref _buffer.Gauges[index].Value, value);
                            }
                        """);
                }
                else if (metric.Tag1FullyQualifiedName is { } tagName)
                {
                    sb.AppendLine(
                        $$"""
                            public void Record{{details.ShortName}}{{property}}({{tagName}} tag, int value)
                            {
                                var index = {{index}} + (int)tag;
                                Interlocked.Exchange(ref _buffer.Gauges[index].Value, value);
                            }
                        """);
                }
                else
                {
                    sb.AppendLine(
                        $$"""
                            public void Record{{details.ShortName}}{{property}}(int value)
                            {
                                Interlocked.Exchange(ref _buffer.Gauges[{{index}}].Value, value);
                            }
                        """);
                }
            }
        }

        sb.Append(
            $$"""

                /// <summary>
                /// Creates the buffer for the <see cref="{{details.FullyQualifiedName}}" /> values.
                /// </summary>
                private static MetricKey[] Get{{details.ShortName}}Buffer()
                    => new MetricKey[]
                    {

            """);
        AddMetricKeys(sb, in details, enumDictionary);
        sb.Append(
            $$"""
                    };

                /// <summary>
                /// Gets an array of metric counts, indexed by integer value of the <see cref="{{details.FullyQualifiedName}}" />.
                /// Each value represents the number of unique entries in the buffer returned by <see cref="Get{{details.ShortName}}Buffer()" />
                /// It is equal to the cardinality of the tag combinations (or 1 if there are no tags)
                /// </summary>
                private static int[] {{details.ShortName}}EntryCounts { get; }
                    = new []{ 
            """);

        foreach (var value in entryCounts)
        {
            sb.Append(value).Append(", ");
        }

        sb.AppendLine("};").Append("}");

        return sb.ToString();
    }

    public static string CreateGaugeITelemetryCollectorPartial(StringBuilder sb, in TelemetryMetricGenerator.EnumDetails details, Dictionary<string, EquatableArray<string>> enumDictionary)
    {
        sb.Clear();
        sb.Append(
            """
            // <auto-generated/>
            #nullable enable

            namespace Datadog.Trace.Telemetry;
            internal partial interface IMetricsTelemetryCollector
            {
            """);

        if (details.Names.AsArray() is { } names)
        {
            for (var i = 0; i < names.Length; i++)
            {
                sb.AppendLine();
                var (property, metric) = names[i];

                if (metric.Tag2FullyQualifiedName is { } tagName2)
                {
                    var tagName1 = metric.Tag1FullyQualifiedName!;
                    sb.AppendLine(
                        $$"""
                            public void Record{{details.ShortName}}{{property}}({{tagName1}} tag1, {{tagName2}} tag2, int value);
                        """);
                }
                else if (metric.Tag1FullyQualifiedName is { } tagName)
                {
                    sb.AppendLine(
                        $$"""
                            public void Record{{details.ShortName}}{{property}}({{tagName}} tag, int value);
                        """);
                }
                else
                {
                    sb.AppendLine(
                        $$"""
                            public void Record{{details.ShortName}}{{property}}(int value);
                        """);
                }
            }
        }

        sb.Append("}");
        return sb.ToString();
    }

    public static string CreateGaugeNullTelemetryCollectorPartial(StringBuilder sb, in TelemetryMetricGenerator.EnumDetails details, Dictionary<string, EquatableArray<string>> enumDictionary)
    {
        sb.Clear();
        sb.Append(
            """
            // <auto-generated/>
            #nullable enable

            namespace Datadog.Trace.Telemetry;
            internal partial class NullMetricsTelemetryCollector
            {
            """);

        if (details.Names.AsArray() is { } names)
        {
            for (var i = 0; i < names.Length; i++)
            {
                sb.AppendLine();
                var (property, metric) = names[i];

                if (metric.Tag2FullyQualifiedName is { } tagName2)
                {
                    var tagName1 = metric.Tag1FullyQualifiedName!;
                    sb.AppendLine(
                        $$"""
                            public void Record{{details.ShortName}}{{property}}({{tagName1}} tag1, {{tagName2}} tag2, int value)
                            {
                            }
                        """);
                }
                else if (metric.Tag1FullyQualifiedName is { } tagName)
                {
                    sb.AppendLine(
                        $$"""
                            public void Record{{details.ShortName}}{{property}}({{tagName}} tag, int value)
                            {
                            }
                        """);
                }
                else
                {
                    sb.AppendLine(
                        $$"""
                            public void Record{{details.ShortName}}{{property}}(int value)
                            {
                            }
                        """);
                }
            }
        }

        sb.Append("}");
        return sb.ToString();
    }

    public static string CreateDistributionTelemetryCollectorPartial(StringBuilder sb, in TelemetryMetricGenerator.EnumDetails details, Dictionary<string, EquatableArray<string>> enumDictionary, int[] metricsToLocation, int[] entryCounts)
    {
        sb.Clear();
        sb.Append(
            """
            // <auto-generated/>
            #nullable enable

            using System.Threading;

            namespace Datadog.Trace.Telemetry;
            internal partial class MetricsTelemetryCollector
            {
            """);

        if (details.Names.AsArray() is { } names)
        {
            for (var i = 0; i < names.Length; i++)
            {
                sb.AppendLine();
                var (property, metric) = names[i];
                var index = metricsToLocation[i];

                if (metric.Tag2FullyQualifiedName is { } tagName2)
                {
                    var tagName1 = metric.Tag1FullyQualifiedName!;
                    var tag2EntryCount = enumDictionary[tagName2].Count;
                    sb.AppendLine(
                        $$"""
                            public void Record{{details.ShortName}}{{property}}({{tagName1}} tag1, {{tagName2}} tag2, double value)
                            {
                                var index = {{index}} + ((int)tag1 * {{tag2EntryCount}}) + (int)tag2;
                                _buffer.Distributions[index].Values.TryEnqueue(value);
                            }
                        """);
                }
                else if (metric.Tag1FullyQualifiedName is { } tagName)
                {
                    sb.AppendLine(
                        $$"""
                            public void Record{{details.ShortName}}{{property}}({{tagName}} tag, double value)
                            {
                                var index = {{index}} + (int)tag;
                                _buffer.Distributions[index].Values.TryEnqueue(value);
                            }
                        """);
                }
                else
                {
                    sb.AppendLine(
                        $$"""
                            public void Record{{details.ShortName}}{{property}}(double value)
                            {
                                _buffer.Distributions[{{index}}].Values.TryEnqueue(value);
                            }
                        """);
                }
            }
        }

        sb.Append(
            $$"""

                /// <summary>
                /// Creates the buffer for the <see cref="{{details.FullyQualifiedName}}" /> values.
                /// </summary>
                private static DistributionKey[] Get{{details.ShortName}}Buffer()
                    => new DistributionKey[]
                    {

            """);
        AddMetricKeys(sb, in details, enumDictionary);
        sb.Append(
            $$"""
                    };

                /// <summary>
                /// Gets an array of metric counts, indexed by integer value of the <see cref="{{details.FullyQualifiedName}}" />.
                /// Each value represents the number of unique entries in the buffer returned by <see cref="Get{{details.ShortName}}Buffer()" />
                /// It is equal to the cardinality of the tag combinations (or 1 if there are no tags)
                /// </summary>
                private static int[] {{details.ShortName}}EntryCounts { get; }
                    = new []{ 
            """);

        foreach (var value in entryCounts)
        {
            sb.Append(value).Append(", ");
        }

        sb.AppendLine("};").Append("}");

        return sb.ToString();
    }

    public static string CreateDistributionITelemetryCollectorPartial(StringBuilder sb, in TelemetryMetricGenerator.EnumDetails details, Dictionary<string, EquatableArray<string>> enumDictionary)
    {
        sb.Clear();
        sb.Append(
            """
            // <auto-generated/>
            #nullable enable

            namespace Datadog.Trace.Telemetry;
            internal partial interface IMetricsTelemetryCollector
            {
            """);

        if (details.Names.AsArray() is { } names)
        {
            for (var i = 0; i < names.Length; i++)
            {
                sb.AppendLine();
                var (property, metric) = names[i];

                if (metric.Tag2FullyQualifiedName is { } tagName2)
                {
                    var tagName1 = metric.Tag1FullyQualifiedName!;
                    sb.AppendLine(
                        $$"""
                            public void Record{{details.ShortName}}{{property}}({{tagName1}} tag1, {{tagName2}} tag2, double value);
                        """);
                }
                else if (metric.Tag1FullyQualifiedName is { } tagName)
                {
                    sb.AppendLine(
                        $$"""
                            public void Record{{details.ShortName}}{{property}}({{tagName}} tag, double value);
                        """);
                }
                else
                {
                    sb.AppendLine(
                        $$"""
                            public void Record{{details.ShortName}}{{property}}(double value);
                        """);
                }
            }
        }

        sb.Append("}");
        return sb.ToString();
    }

    public static string CreateDistributionNullTelemetryCollectorPartial(StringBuilder sb, in TelemetryMetricGenerator.EnumDetails details, Dictionary<string, EquatableArray<string>> enumDictionary)
    {
        sb.Clear();
        sb.Append(
            """
            // <auto-generated/>
            #nullable enable

            namespace Datadog.Trace.Telemetry;
            internal partial class NullMetricsTelemetryCollector
            {
            """);

        if (details.Names.AsArray() is { } names)
        {
            for (var i = 0; i < names.Length; i++)
            {
                sb.AppendLine();
                var (property, metric) = names[i];

                if (metric.Tag2FullyQualifiedName is { } tagName2)
                {
                    var tagName1 = metric.Tag1FullyQualifiedName!;
                    sb.AppendLine(
                        $$"""
                            public void Record{{details.ShortName}}{{property}}({{tagName1}} tag1, {{tagName2}} tag2, double value)
                            {
                            }
                        """);
                }
                else if (metric.Tag1FullyQualifiedName is { } tagName)
                {
                    sb.AppendLine(
                        $$"""
                            public void Record{{details.ShortName}}{{property}}({{tagName}} tag, double value)
                            {
                            }
                        """);
                }
                else
                {
                    sb.AppendLine(
                        $$"""
                            public void Record{{details.ShortName}}{{property}}(double value)
                            {
                            }
                        """);
                }
            }
        }

        sb.Append("}");
        return sb.ToString();
    }

    private static void AddMetricKeys(StringBuilder sb, in TelemetryMetricGenerator.EnumDetails details, Dictionary<string, EquatableArray<string>> enumDictionary)
    {
        var names = details.Names.AsArray();
        if (names is null)
        {
            return;
        }

        foreach (var (_, metric) in names)
        {
            const string prefix =
                """
                            new(
                """;
            if (metric.Tag1FullyQualifiedName is { } tag1Type && enumDictionary[tag1Type].AsArray() is { } tag1Values)
            {
                foreach (var tag1Value in tag1Values)
                {
                    if (metric.Tag2FullyQualifiedName is { } tag2Type && enumDictionary[tag2Type].AsArray() is { } tag2Values)
                    {
                        foreach (var tag2Value in tag2Values)
                        {
                            sb.Append(prefix)
                              .Append("new[] { \"")
                              .Append(tag1Value)
                              .Append("\", \"")
                              .Append(tag2Value)
                              .AppendLine("\" }),");
                        }
                    }
                    else
                    {
                        sb.Append(prefix)
                          .Append("new[] { \"")
                          .Append(tag1Value)
                          .AppendLine("\" }),");
                    }
                }
            }
            else
            {
                sb
                   .Append(prefix)
                   .AppendLine("null),");
            }
        }
    }

    private static string GetNames(StringBuilder sb, in TelemetryMetricGenerator.EnumDetails details)
        => GetValues(sb, in details, static (s, m) => s.Append('"').Append(m.MetricName).Append('"'));

    private static string GetIsCommon(StringBuilder sb, in TelemetryMetricGenerator.EnumDetails details)
        => GetValues(sb, in details, static (s, m) => s.Append("false"), m => !m.IsCommon);

    private static string GetNamespaces(StringBuilder sb, in TelemetryMetricGenerator.EnumDetails details)
        => GetValues(sb, in details, static (s, m) => s.Append('"').Append(m.NameSpace).Append('"'), static m => !string.IsNullOrEmpty(m.NameSpace));

    private static string GetValues(
        StringBuilder sb,
        in TelemetryMetricGenerator.EnumDetails details,
        Action<StringBuilder, TelemetryMetricGenerator.MetricDetails> action,
        Func<TelemetryMetricGenerator.MetricDetails, bool>? predicate = null)
    {
        var names = details.Names.AsArray();
        if (names is null)
        {
            return string.Empty;
        }

        sb.Clear();
        foreach (var (property, metric) in names)
        {
            if (predicate is { } && !predicate(metric))
            {
                continue;
            }

            sb.Append(
                   @"
            ")
              .Append(details.FullyQualifiedName)
              .Append('.')
              .Append(property)
              .Append(" => ");
            action(sb, metric);
            sb.Append(',');
        }

        return sb.ToString();
    }
}
