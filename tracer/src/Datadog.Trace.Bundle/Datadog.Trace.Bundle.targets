<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <Target Name="DatadogAfterComputeResolvedFilesToPublishList" AfterTargets="ComputeResolvedFilesToPublishList" Condition="'$(RemoveUnusedDatadogFiles)' == 'true'">
    <PropertyGroup>
      <!-- TargetFrameworks that use directory net461/ -->
      <DatadogTargetFramework Condition="'$(DatadogTargetFramework)' == '' AND '$(TargetFrameworkIdentifier)' == '.NETFramework' AND
                                         $([MSBuild]::IsTargetFrameworkCompatible('$(TargetFramework)', 'net461'))">net461</DatadogTargetFramework>

      <!-- NOTE: keep the <DatadogTargetFramework> below in order from newest .NET runtime to oldest, and netstandard2.0 last.
           This way we use the most recent runtime that is compatible. -->

      <!-- TargetFrameworks that use directory net6.0/ -->
      <DatadogTargetFramework Condition="'$(DatadogTargetFramework)' == '' AND '$(TargetFrameworkIdentifier)' != '.NETFramework' AND
                                         $([MSBuild]::IsTargetFrameworkCompatible('$(TargetFramework)', 'net6.0'))">net6.0</DatadogTargetFramework>

      <!-- TargetFrameworks that use directory netcoreapp3.1/ -->
      <DatadogTargetFramework Condition="'$(DatadogTargetFramework)' == '' AND '$(TargetFrameworkIdentifier)' != '.NETFramework' AND
                                         $([MSBuild]::IsTargetFrameworkCompatible('$(TargetFramework)', 'net6.0'))">netcoreapp3.1</DatadogTargetFramework>

      <!-- TargetFrameworks that use directory netstandard2.0/ -->
      <DatadogTargetFramework Condition="'$(DatadogTargetFramework)' == '' AND '$(TargetFrameworkIdentifier)' != '.NETFramework' AND
                                         $([MSBuild]::IsTargetFrameworkCompatible('$(TargetFramework)', 'netstandard2.0'))">netstandard2.0</DatadogTargetFramework>

      <!-- special DatadogRuntimeIdentifier handling for in .NET Framework -->
      <DatadogRuntimeIdentifier Condition="'$(DatadogRuntimeIdentifier)' == '' AND '$(TargetFrameworkIdentifier)' == '.NETFramework' AND '$(PlatformTarget)' == 'x64'">win-x64</DatadogRuntimeIdentifier>
      <DatadogRuntimeIdentifier Condition="'$(DatadogRuntimeIdentifier)' == '' AND '$(TargetFrameworkIdentifier)' == '.NETFramework' AND '$(PlatformTarget)' == 'x86'">win-x86</DatadogRuntimeIdentifier>
      <DatadogRuntimeIdentifier Condition="'$(DatadogRuntimeIdentifier)' == '' AND '$(TargetFrameworkIdentifier)' == '.NETFramework'">win-</DatadogRuntimeIdentifier>
      <DatadogRuntimeIdentifier Condition="'$(DatadogRuntimeIdentifier)' == ''">$(RuntimeIdentifier)</DatadogRuntimeIdentifier>
    </PropertyGroup>

    <Message Importance="High" Text="[Datadog.Trace.Bundle] DatadogTargetFramework: $(DatadogTargetFramework), DatadogRuntimeIdentifier: $(DatadogRuntimeIdentifier)" />

    <Error Condition="'$(DatadogTargetFramework)' == ''"
           Text="[Datadog.Trace.Bundle] TargetFramework &quot;$(TargetFramework)&quot; is not supported. To ignore this error and include all files, set build property RemoveUnusedDatadogFiles=false. For more compatiblity details, see https://docs.datadoghq.com/tracing/trace_collection/compatibility/dotnet-core and https://docs.datadoghq.com/tracing/trace_collection/compatibility/dotnet-framework. For assistance, contact our support team at https://www.datadoghq.com/support/." />

    <!-- ResolvedFileToPublish is populated in target ComputeResolvedFilesToPublishList,
         see https://github.com/dotnet/sdk/blob/67f43d9366503d46a1063319a93a388b705ae8a5/src/Tasks/Microsoft.NET.Build.Tasks/targets/Microsoft.NET.Publish.targets#L504
         The following lines remove the files we DON'T want published from ResolvedFileToPublish -->
    <ItemGroup>
      <!-- if $(DatadogRuntimeIdentifier) is set, remove files that don't match -->
      <!-- note: currently there are two osx directories: "osx" and "osx-x64", so we can't use "osx-*" -->
      <DatadogFilesToRemove Include="@(ResolvedFileToPublish)"
                            Condition="'$(DatadogRuntimeIdentifier)' != '' AND
                                         ($([System.String]::Copy('%(ResolvedFileToPublish.RelativePath)').ToLower().StartsWith('datadog\win-')) OR
                                          $([System.String]::Copy('%(ResolvedFileToPublish.RelativePath)').ToLower().StartsWith('datadog\linux-')) OR
                                          $([System.String]::Copy('%(ResolvedFileToPublish.RelativePath)').ToLower().StartsWith('datadog\osx'))) AND
                                       !$([System.String]::Copy('%(ResolvedFileToPublish.RelativePath)').ToLower().StartsWith('datadog\$(DatadogRuntimeIdentifier)'))" />

      <!-- if $(DatadogTargetFramework) is set, remove the managed library directories that don't match -->
      <DatadogFilesToRemove Include="@(ResolvedFileToPublish)"
                            Condition="'$(DatadogTargetFramework)' != '' AND
                                        $([System.String]::Copy('%(ResolvedFileToPublish.RelativePath)').ToLower().StartsWith('datadog\net')) AND
                                        !$([System.String]::Copy('%(ResolvedFileToPublish.RelativePath)').ToLower().StartsWith('datadog\$(DatadogTargetFramework)'))" />

      <ResolvedFileToPublish Remove="@(DatadogFilesToRemove)" />
    </ItemGroup>

    <Message Importance="High" Text="[Datadog.Trace.Bundle] Removed from ResolvedFileToPublish: %(DatadogFilesToRemove.RelativePath)" />
  </Target>
</Project>
