<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <Version>2.14.0</Version>
    <Title>Datadog APM Auto-instrumentation Runner</Title>
    <Copyright>Copyright 2020 Datadog, Inc.</Copyright>
    <Description>Auto-instrumentation dotnet global tool for Datadog APM</Description>
    <OutputType>Exe</OutputType>
    <TargetFrameworks>net6.0;net5.0;netcoreapp3.1;netcoreapp3.0;netcoreapp2.2;netcoreapp2.1;</TargetFrameworks>
    <CopyLocalLockFileAssemblies>true</CopyLocalLockFileAssemblies>
    <NoWarn>NU5100</NoWarn>
    <RootNamespace>Datadog.Trace.Tools.Runner</RootNamespace>
    <AllowUnsafeBlocks>true</AllowUnsafeBlocks>

    <!-- Required for StrongNamer: https://github.com/dsplaisted/strongnamer/issues/61 -->
    <ErrorOnDuplicatePublishOutputFiles>False</ErrorOnDuplicatePublishOutputFiles>

    <!-- Hide warnings for EOL .NET Core targets (e.g. netcoreapp3.0) -->
    <CheckEolTargetFramework>false</CheckEolTargetFramework>
  </PropertyGroup>

  <Choose>
    <When Condition="'$(BuildStandalone)' == 'true'">
      <PropertyGroup>
        <OutputPath>bin\$(Configuration)\Console</OutputPath>
        <PublishDir Condition="'$(PublishDir)' == '' ">bin\$(Configuration)\Console\publish\$(RuntimeIdentifier)</PublishDir>
        <AssemblyName>dd-trace</AssemblyName>
        <RuntimeIdentifiers>win-x64;win-x86;linux-x64;linux-musl-x64;osx-x64;linux-arm64</RuntimeIdentifiers>
        <CopyLocalLockFileAssemblies>true</CopyLocalLockFileAssemblies>
        <PublishTrimmed>true</PublishTrimmed>
        <PublishSingleFile>true</PublishSingleFile>
        <IncludeAllContentForSelfExtract>true</IncludeAllContentForSelfExtract>
      </PropertyGroup>
      <ItemGroup>
        <Content Include="..\Datadog.Monitoring.Distribution\home\**\*.*" LinkBase="home">
          <CopyToOutputDirectory>Always</CopyToOutputDirectory>
          <CopyToPublishDirectory>Always</CopyToPublishDirectory>
        </Content>

        <Content Update="..\Datadog.Monitoring.Distribution\home\**\readme.txt">
          <CopyToOutputDirectory>Never</CopyToOutputDirectory>
          <CopyToPublishDirectory>Never</CopyToPublishDirectory>
        </Content>
        
        <Content Update="..\Datadog.Monitoring.Distribution\home\**\*.pdb">
          <CopyToOutputDirectory>Never</CopyToOutputDirectory>
          <CopyToPublishDirectory>Never</CopyToPublishDirectory>
        </Content>
      </ItemGroup>
    </When>
    <Otherwise>
      <PropertyGroup>
        <IsPackable>true</IsPackable>
        <PackAsTool>true</PackAsTool>
        <ToolCommandName>dd-trace</ToolCommandName>
        <PublishRepositoryUrl>true</PublishRepositoryUrl>
        <EmbedUntrackedSources>true</EmbedUntrackedSources>
        <GeneratePackageOnBuild>true</GeneratePackageOnBuild>
        <PackageId>dd-trace</PackageId>
        <OutputPath>bin\$(Configuration)\Tool</OutputPath>
      </PropertyGroup>
      <ItemGroup>
        <Content Include="..\Datadog.Monitoring.Distribution\home\**\*.*" Pack="true" PackagePath="\home" LinkBase="home">
          <CopyToOutputDirectory>Never</CopyToOutputDirectory>
        </Content>

        <Content Update="..\Datadog.Monitoring.Distribution\home\**\readme.txt" Pack="false">
          <CopyToOutputDirectory>Never</CopyToOutputDirectory>
        </Content>
      </ItemGroup>
    </Otherwise>
  </Choose>

  <ItemGroup>
    <PackageReference Include="Microsoft.Win32.Registry" Version="5.0.0" />
    <PackageReference Include="Mono.Cecil" Version="0.11.4" />
    <PackageReference Include="Spectre.Console" Version="0.43.0" />
    <PackageReference Include="StrongNamer" Version="0.2.5" />
    <PackageReference Include="Microsoft.Web.Administration" Version="11.1.0" />
    <PackageReference Include="NETStandard.Library" Version="2.0.3" />
    <PackageReference Include="System.Runtime.InteropServices" Version="4.3.0" />
    <PackageReference Include="System.Management" Version="5.0.0" />
  </ItemGroup>

  <ItemGroup>
    <ProjectReference Include="..\Datadog.Trace\Datadog.Trace.csproj" />
    <ProjectReference Include="..\Datadog.Trace.Coverage.collector\Datadog.Trace.Coverage.collector.csproj" />
  </ItemGroup>

  <Target Name="RemoveDuplicate" AfterTargets="ComputeFilesToPublish" BeforeTargets="_HandleFileConflictsForPublish">
    <!-- Required for StrongNamer: https://github.com/dsplaisted/strongnamer/issues/61 -->
    <PropertyGroup>
      <DuplicateFileToRemove>$(BaseIntermediateOutputPath)$(Configuration)\$(TargetFramework)\$(RuntimeIdentifier)\linked\Spectre.Console.dll</DuplicateFileToRemove>
    </PropertyGroup>

    <Message Text="Removing $(DuplicateFileToRemove) from publish output" Importance="high" />
    <ItemGroup>
      <ResolvedFileToPublish Remove="$(DuplicateFileToRemove)" />
    </ItemGroup>
  </Target>
</Project>
