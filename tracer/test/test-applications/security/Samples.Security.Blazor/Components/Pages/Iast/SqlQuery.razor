@page "/Iast/SqlQuery/"
@using System.Data.SQLite
@using Datadog.Trace.Annotations.Controllers
@inject NavigationManager NavigationManager
@using Microsoft.AspNetCore.WebUtilities

<h3>SQL Query</h3>

<p>@_message</p>

@code {
    private string? Username { get; set; }
    private string? Query { get; set; }

    private string? _message;

    protected override void OnInitialized()
    {
        var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
        var urlQuery = QueryHelpers.ParseQuery(uri.Query);
        
        if (urlQuery.TryGetValue("username", out var username))
        {
            Username = username;
        }
        
        if (urlQuery.TryGetValue("query", out var query))
        {
            Query = query;
        }
        
        try
        {
            if (!string.IsNullOrEmpty(Username))
            {
                var taintedQuery = "SELECT Surname from Persons where name = '" + Username + "'";
                var name = new SQLiteCommand(taintedQuery, IastController.Instance.DbConnection).ExecuteScalar();
                _message = $"Result: " + name;
            }

            if (!string.IsNullOrEmpty(Query))
            {
                var name = new SQLiteCommand(Query, IastController.Instance.DbConnection).ExecuteScalar();
                _message = $"Result: " + name;
            }
        }
        catch (Exception ex)
        {
            _message = $"Error: " + ex.Message;
        }

        if (string.IsNullOrEmpty(_message))
        {
            _message = $"No query or username was provided";
        }
    }
}