// <copyright file="ConfigurationKeysGeneratorTests.cs" company="Datadog">
// Unless explicitly stated otherwise all files in this repository are licensed under the Apache 2 License.
// This product includes software developed at Datadog (https://www.datadoghq.com/). Copyright 2017 Datadog, Inc.
// </copyright>

#nullable enable

using System.Linq;
using FluentAssertions;
using FluentAssertions.Execution;
using Xunit;

namespace Datadog.Trace.SourceGenerators.Tests;

public class ConfigurationKeysGeneratorTests
{
    private const string Header = """
                                  // <copyright company="Datadog">
                                  // Unless explicitly stated otherwise all files in this repository are licensed under the Apache 2 License.
                                  // This product includes software developed at Datadog (https://www.datadoghq.com/). Copyright 2017 Datadog, Inc.
                                  // </copyright>
                                  // <auto-generated/>
                                  
                                  #nullable enable
                                  
                                  namespace Datadog.Trace.Configuration;
                                  """;

    [Fact]
    public void GeneratesProductPartialClassesAndHeader()
    {
        const string supportedConfigYaml = """
                                           version: '2'
                                           supportedConfigurations:
                                             DD_TRACE_ENABLED:
                                             - implementation: A
                                               product: Tracer
                                               documentation: |-
                                                 Enables or disables the tracer.
                                                 Default is true.
                                             DD_APPSEC_ENABLED:
                                             - implementation: A
                                               product: AppSec
                                               documentation: |-
                                                 Enables or disables AppSec.
                                                 Default is false.
                                             OTEL_EXPORTER_OTLP_ENDPOINT:
                                             - implementation: A
                                               product: OpenTelemetry
                                               documentation: |-
                                                 Configuration key to set the OTLP endpoint URL (fallback for metrics-specific endpoint).
                                                 Used when <see cref="ExporterOtlpMetricsEndpoint"/> is not set.
                                                 Expects values like `unix:///path/to/socket.sock` for UDS, `\\.\pipename\` for Windows Named Pipes.
                                                 Default values: gRPC: http://localhost:4317, HTTP: http://localhost:4318
                                           """;

        const string expectedTracerOutput =
            """
                internal static class Tracer
                {
                    /// <summary>
                    /// Enables or disables the tracer.
                    /// Default is true.
                    /// </summary>
                    public const string Enabled = "DD_TRACE_ENABLED";
                }
            """;

        const string expectedAppSecOutput =
            """
                internal static class AppSec
                {
                    /// <summary>
                    /// Enables or disables AppSec.
                    /// Default is false.
                    /// </summary>
                    public const string Enabled = "DD_APPSEC_ENABLED";
                }
            """;

        const string expectedTelemOutput =
            """
                internal static class OpenTelemetry
                {
                    /// <summary>
                    /// Configuration key to set the OTLP endpoint URL (fallback for metrics-specific endpoint).
                    /// Used when <see cref="ExporterOtlpMetricsEndpoint"/> is not set.
                    /// Expects values like `unix:///path/to/socket.sock` for UDS, `\\.\pipename\` for Windows Named Pipes.
                    /// Default values: gRPC: http://localhost:4317, HTTP: http://localhost:4318
                    /// </summary>
                    public const string ExporterOtlpEndpoint = "OTEL_EXPORTER_OTLP_ENDPOINT";
                }
            """;

        var (diagnostics, outputs) = TestHelpers.GetGeneratedTrees<ConfigurationKeysGenerator>(
            [],
            [],
            [("supported-configurations.yaml", supportedConfigYaml)],
            assertOutput: false);

        using var s = new AssertionScope();
        diagnostics.Should().BeEmpty();
        outputs.Should().HaveCount(3);
        var appSecOutput = outputs.First(o => o.Contains("AppSec"));
        var tracerOutput = outputs.First(o => o.Contains("Tracer"));
        var telemOutput = outputs.First(o => o.Contains("OpenTelemetry"));

        tracerOutput.Should().NotBeNullOrEmpty();
        appSecOutput.Should().NotBeNullOrEmpty();
        telemOutput.Should().NotBeNullOrEmpty();
        tracerOutput.Should().Contain(Header);
        appSecOutput.Should().Contain(Header);
        telemOutput.Should().Contain(Header);
        tracerOutput.Should().Contain(expectedTracerOutput);
        appSecOutput.Should().Contain(expectedAppSecOutput);
        telemOutput.Should().Contain(expectedTelemOutput);
    }

    [Fact]
    public void StripsProductPrefixFromConstNames()
    {
        const string supportedConfigYaml =
            """
            version: '2'
            supportedConfigurations:
              DD_CIVISIBILITY_AGENTLESS_ENABLED:
              - implementation: A
                product: CiVisibility
                documentation: Enables agentless mode for CI Visibility.
              DD_APPSEC_WAF_TIMEOUT:
              - implementation: A
                product: AppSec
                documentation: WAF timeout in microseconds.
              DD_TRACE_REMOVE_INTEGRATION_SERVICE_NAMES_ENABLED:
              - implementation: A
                product: Tracer
                documentation: Removes integration service names.
            """;

        const string expectedCIOutput =
            """
                internal static class CiVisibility
                {
                    /// <summary>
                    /// Enables agentless mode for CI Visibility.
                    /// </summary>
                    public const string AgentlessEnabled = "DD_CIVISIBILITY_AGENTLESS_ENABLED";
                }
            """;

        const string expectedAppSecOutput =
            """
                internal static class AppSec
                {
                    /// <summary>
                    /// WAF timeout in microseconds.
                    /// </summary>
                    public const string WafTimeout = "DD_APPSEC_WAF_TIMEOUT";
                }
            """;
        const string expectedTracerOutput =
            """
                internal static class Tracer
                {
                    /// <summary>
                    /// Removes integration service names.
                    /// </summary>
                    public const string RemoveIntegrationServiceNamesEnabled = "DD_TRACE_REMOVE_INTEGRATION_SERVICE_NAMES_ENABLED";
                }
            """;

        var (diagnostics, outputs) = TestHelpers.GetGeneratedTrees<ConfigurationKeysGenerator>(
            [],
            [],
            [("supported-configurations.yaml", supportedConfigYaml)],
            assertOutput: false);

        using var s = new AssertionScope();
        diagnostics.Should().BeEmpty();

        var ciOutput = outputs.FirstOrDefault(o => o.Contains("class CiVisibility"));
        var appSecOutput = outputs.FirstOrDefault(o => o.Contains("class AppSec"));
        var tracerOutput = outputs.FirstOrDefault(o => o.Contains("class Tracer"));

        ciOutput.Should().NotBeNullOrEmpty();
        appSecOutput.Should().NotBeNullOrEmpty();
        tracerOutput.Should().NotBeNullOrEmpty();

        ciOutput.Should().Contain(expectedCIOutput);
        appSecOutput.Should().Contain(expectedAppSecOutput);
        tracerOutput.Should().Contain(expectedTracerOutput);
    }

    [Fact]
    public void HandlesKeysWithoutProduct()
    {
        const string supportedConfigYaml = """
                                           version: '2'
                                           supportedConfigurations:
                                             DD_ENV:
                                             - implementation: A
                                               documentation: The environment name.
                                             DD_SERVICE:
                                             - implementation: A
                                               documentation: The service name.
                                           """;

        var (diagnostics, outputs) = TestHelpers.GetGeneratedTrees<ConfigurationKeysGenerator>(
            [],
            [],
            [("supported-configurations.yaml", supportedConfigYaml)],
            assertOutput: false);

        using var s = new AssertionScope();
        diagnostics.Should().BeEmpty();

        // Keys without product should go in the main class
        var mainOutput = outputs.FirstOrDefault(o => o.Contains("partial class ConfigurationKeys") && !o.Contains("class Tracer") && !o.Contains("class AppSec"));
        mainOutput.Should().NotBeNullOrEmpty();
        mainOutput.Should().Contain("public const string Env = \"DD_ENV\";");
        mainOutput.Should().Contain("public const string Service = \"DD_SERVICE\";");
    }

    [Fact]
    public void IncludesXmlDocumentation()
    {
        const string supportedConfigYaml = """
                                           version: '2'
                                           supportedConfigurations:
                                             DD_TRACE_ENABLED:
                                             - implementation: A
                                               product: Tracer
                                               documentation: |-
                                                 Enables or disables the Datadog tracer.
                                                 Default: true
                                           """;

        var (diagnostics, outputs) = TestHelpers.GetGeneratedTrees<ConfigurationKeysGenerator>(
            [],
            [],
            [("supported-configurations.yaml", supportedConfigYaml)],
            assertOutput: false);

        using var s = new AssertionScope();
        diagnostics.Should().BeEmpty();

        var tracerOutput = outputs.FirstOrDefault(o => o.Contains("class Tracer"));
        tracerOutput.Should().NotBeNullOrEmpty();
        tracerOutput.Should().Contain("/// <summary>");
        tracerOutput.Should().Contain("/// Enables or disables the Datadog tracer.");
        tracerOutput.Should().Contain("/// Default: true");
        tracerOutput.Should().Contain("/// </summary>");
    }

    [Fact]
    public void HandlesEmptyConfiguration()
    {
        const string supportedConfigYaml = """
                                           version: '2'
                                           supportedConfigurations:
                                           """;

        var (diagnostics, outputs) = TestHelpers.GetGeneratedTrees<ConfigurationKeysGenerator>(
            [],
            [],
            [("supported-configurations.yaml", supportedConfigYaml)],
            assertOutput: false);

        diagnostics.Should().BeEmpty();
        outputs.Should().BeEmpty();
    }

    [Fact]
    public void HandlesMissingYamlFile()
    {
        var (diagnostics, outputs) = TestHelpers.GetGeneratedTrees<ConfigurationKeysGenerator>(
            [],
            [],
            [],
            assertOutput: false);

        diagnostics.Should().Contain(d => d.Id == "DDSG0005");
    }

    [Fact]
    public void HandlesInvalidYaml()
    {
        const string invalidYaml = """
                                   version: '2'
                                   supportedConfigurations:
                                     DD_TRACE_ENABLED: invalid_not_a_list
                                   """;

        var (diagnostics, outputs) = TestHelpers.GetGeneratedTrees<ConfigurationKeysGenerator>(
            [],
            [],
            [("supported-configurations.yaml", invalidYaml)],
            assertOutput: false);

        // The parser should handle this gracefully - either no configs or a missing documentation error
        (diagnostics.Any() || !outputs.Any()).Should().BeTrue();
    }

    [Fact]
    public void SortsEntriesAlphabeticallyByEnvironmentVariable()
    {
        const string supportedConfigYaml = """
                                           version: '2'
                                           supportedConfigurations:
                                             DD_TRACE_SAMPLE_RATE:
                                             - implementation: A
                                               product: Tracer
                                               documentation: Sets the sample rate.
                                             DD_TRACE_ENABLED:
                                             - implementation: A
                                               product: Tracer
                                               documentation: Enables the tracer.
                                             DD_TRACE_DEBUG:
                                             - implementation: A
                                               product: Tracer
                                               documentation: Enables debug mode.
                                           """;

        var (diagnostics, outputs) = TestHelpers.GetGeneratedTrees<ConfigurationKeysGenerator>(
            [],
            [],
            [("supported-configurations.yaml", supportedConfigYaml)],
            assertOutput: false);

        using var s = new AssertionScope();
        diagnostics.Should().BeEmpty();

        var tracerOutput = outputs.FirstOrDefault(o => o.Contains("class Tracer"));
        tracerOutput.Should().NotBeNullOrEmpty();

        var debugIndex = tracerOutput!.IndexOf("Debug = \"DD_TRACE_DEBUG\"");
        var enabledIndex = tracerOutput!.IndexOf("Enabled = \"DD_TRACE_ENABLED\"");
        var sampleRateIndex = tracerOutput!.IndexOf("SampleRate = \"DD_TRACE_SAMPLE_RATE\"");

        debugIndex.Should().BeLessThan(enabledIndex);
        enabledIndex.Should().BeLessThan(sampleRateIndex);
    }

    [Fact]
    public void HandlesSeeAlsoTagsCorrectly()
    {
        const string supportedConfigYaml = """
                                           version: '2'
                                           supportedConfigurations:
                                             DD_TRACE_ENABLED:
                                             - implementation: A
                                               product: Tracer
                                               documentation: |-
                                                 Configuration key for enabling or disabling the Tracer.
                                                 Default is value is true (enabled).
                                                 <seealso cref="Datadog.Trace.Configuration.TracerSettings.TraceEnabled"/>
                                             DD_LOGS_INJECTION:
                                             - implementation: A
                                               product: Tracer
                                               documentation: |-
                                                 Configuration key for enabling or disabling the automatic injection
                                                 of correlation identifiers into the logging context.
                                                 <seealso cref="Datadog.Trace.Configuration.TracerSettings.LogsInjectionEnabled"></seealso>
                                           """;

        const string expectedEnabledOutput =
                    """
                        internal static class Tracer
                        {
                            /// <summary>
                            /// Configuration key for enabling or disabling the automatic injection
                            /// of correlation identifiers into the logging context.
                            /// </summary>
                            /// <seealso cref="Datadog.Trace.Configuration.TracerSettings.LogsInjectionEnabled"></seealso>
                            public const string LogsInjection = "DD_LOGS_INJECTION";

                            /// <summary>
                            /// Configuration key for enabling or disabling the Tracer.
                            /// Default is value is true (enabled).
                            /// </summary>
                            /// <seealso cref="Datadog.Trace.Configuration.TracerSettings.TraceEnabled"/>
                            public const string Enabled = "DD_TRACE_ENABLED";
                        }
                    """;

        var (diagnostics, outputs) = TestHelpers.GetGeneratedTrees<ConfigurationKeysGenerator>(
            [],
            [],
            [("supported-configurations.yaml", supportedConfigYaml)],
            assertOutput: false);

        using var s = new AssertionScope();
        diagnostics.Should().BeEmpty();

        var tracerOutput = outputs.FirstOrDefault(o => o.Contains("class Tracer"));
        tracerOutput.Should().NotBeNullOrEmpty();

        tracerOutput!.Should().Contain(expectedEnabledOutput);
    }

    [Fact]
    public void AddsObsoleteAttributeForDeprecatedKeys()
    {
        const string supportedConfigYaml = """
                                           version: '2'
                                           supportedConfigurations:
                                             DD_MAX_TRACES_PER_SECOND:
                                             - implementation: A
                                               documentation: Configuration key for the maximum number of traces to submit per second.
                                             DD_TRACE_ENABLED:
                                             - implementation: A
                                               documentation: Enables or disables the tracer.
                                           deprecations:
                                             DD_MAX_TRACES_PER_SECOND: This parameter is obsolete and should be replaced by `DD_TRACE_RATE_LIMIT`
                                           """;

        var (diagnostics, outputs) = TestHelpers.GetGeneratedTrees<ConfigurationKeysGenerator>(
            [],
            [],
            [("supported-configurations.yaml", supportedConfigYaml)],
            assertOutput: false);

        using var s = new AssertionScope();
        diagnostics.Should().BeEmpty();

        var mainOutput = outputs.FirstOrDefault(o => o.Contains("partial class ConfigurationKeys") && !o.Contains("internal static class"));
        mainOutput.Should().NotBeNullOrEmpty();

        // Deprecated key should have [Obsolete] attribute
        mainOutput.Should().Contain("[System.Obsolete(\"This parameter is obsolete and should be replaced by `DD_TRACE_RATE_LIMIT`\")]");
        mainOutput.Should().Contain("public const string MaxTracesPerSecond = \"DD_MAX_TRACES_PER_SECOND\";");
        mainOutput.Should().Contain("/// Configuration key for the maximum number of traces to submit per second.");
        mainOutput.Should().Contain("public const string TraceEnabled = \"DD_TRACE_ENABLED\";");
    }

    [Fact]
    public void EmitsErrorWhenDocumentationIsMissing()
    {
        const string supportedConfigYaml = """
                                           version: '2'
                                           supportedConfigurations:
                                             DD_TRACE_ENABLED:
                                             - implementation: A
                                               product: Tracer
                                             DD_TRACE_DEBUG:
                                             - implementation: A
                                               product: Tracer
                                               documentation: Enables debug mode.
                                           """;

        var (diagnostics, _) = TestHelpers.GetGeneratedTrees<ConfigurationKeysGenerator>(
            [],
            [],
            [("supported-configurations.yaml", supportedConfigYaml)],
            assertOutput: false);

        using var s = new AssertionScope();

        // Should emit DDSG0008 for the key missing documentation
        diagnostics.Should().Contain(d => d.Id == "DDSG0008");
        diagnostics.Where(d => d.Id == "DDSG0008").Should().HaveCount(1);
        diagnostics.First(d => d.Id == "DDSG0008").GetMessage().Should().Contain("DD_TRACE_ENABLED").And.Contain("documentation");
    }
}
