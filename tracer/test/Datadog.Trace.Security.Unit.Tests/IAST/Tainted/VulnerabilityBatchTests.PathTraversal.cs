// <copyright file="VulnerabilityBatchTests.PathTraversal.cs" company="Datadog">
// Unless explicitly stated otherwise all files in this repository are licensed under the Apache 2 License.
// This product includes software developed at Datadog (https://www.datadoghq.com/). Copyright 2017 Datadog, Inc.
// </copyright>

using Datadog.Trace.Configuration;
using Datadog.Trace.Iast;
using Datadog.Trace.TestHelpers.FluentAssertionsExtensions.Json;
using FluentAssertions;
using Xunit;

namespace Datadog.Trace.Security.Unit.Tests.IAST.Tainted;

/// <summary>
/// VulnerabilityBatchTests for PATH_TRAVERSAL
/// </summary>
public partial class VulnerabilityBatchTests
{
    [Fact]
    public void GivenAPathTraversal_WhenSerialized_JsonIsNotRedacted()
    {
        var batch = Utils.GetRedactedBatch();
        var source = new Source(3, "file", "my_document.txt");
        var ranges = new Range[]
        {
            new Range(11, 15, source),
        };
        var evidence = new Evidence($"/home/user/my_document.txt", ranges);
        var vulnerability = new Vulnerability("PATH_TRAVERSAL", new Location(), evidence);
        batch.Add(vulnerability);

        var json = batch.ToJson();
        json.Should().BeJsonEquivalentTo(
            """
            {
              "sources": [
                { "origin": "http.request.parameter", "name": "file", "value": "my_document.txt" }
              ],
              "vulnerabilities": [
                {
                  "type": "PATH_TRAVERSAL",
                  "evidence": {
                  "valueParts": [
                      { "value": "/home/user/" },
                      { "value": "my_document.txt", "source": 0 }
                    ]
                  }
                }
              ]
            }
            """,
            _defaultScrubber);
    }
}
