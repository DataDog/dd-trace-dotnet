// <copyright file="MSBuildPropsFileGenerator.cs" company="Datadog">
// Unless explicitly stated otherwise all files in this repository are licensed under the Apache 2 License.
// This product includes software developed at Datadog (https://www.datadoghq.com/). Copyright 2017 Datadog, Inc.
// </copyright>

using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.IO;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace GeneratePackageVersions
{
    public class MSBuildPropsFileGenerator : FileGenerator
    {
        private const string HeaderConst =
@"<!--
***********************************************************************************************
PackageVersions.g.props

NOTE:  This code was generated by the GeneratePackageVersions tool. To safely
       modify this file, edit PackageVersionsGeneratorDefinitions.json and
       re-run the GeneratePackageVersions project in Visual Studio. See the
       launchSettings.json for the project if you would like to run the tool
       with the correct arguments outside of Visual Studio.

***********************************************************************************************
-->
<Project>
  <ItemGroup>";

        private const string FooterConst =
@"  </ItemGroup>
</Project>";

        private const string TargetFrameworkFormat =
@"
      <TargetFramework>{0}</TargetFramework>";

        private const string SkipAlpine =
@"
      <SkipAlpine>true</SkipAlpine>";

        private const string SkipArm64 =
@"
      <SkipArm64>true</SkipArm64>";

        private const string EntryFormat =
@"    <PackageVersionSample Include=""test\test-applications\integrations\{0}\{0}.csproj"">
      <Properties>ApiVersion={1};RestoreRecursive=false;BuildProjectReferences=false</Properties>{2}
      <RequiresDockerDependency>{3}</RequiresDockerDependency>
      <SampleName>{0}</SampleName>
    </PackageVersionSample>";

        public MSBuildPropsFileGenerator(string filename)
            : base(filename)
        {
        }

        protected override string Header
        {
            get
            {
                return HeaderConst;
            }
        }

        protected override string Footer
        {
            get
            {
                return FooterConst;
            }
        }

        public override void Write(PackageVersionEntry packageVersionEntry, IEnumerable<(TargetFramework framework, IEnumerable<Version> versions)> versions, string requiresDockerDependency)
        {
            Debug.Assert(Started, "Cannot call Write() before calling Start()");
            Debug.Assert(!Finished, "Cannot call Write() after calling Finish()");

            foreach (var (framework, packageVersions) in versions)
            {
                string targetFrameworkProperty = string.Format(TargetFrameworkFormat, framework);
                foreach (var packageVersion in packageVersions)
                {
                    string skipAlpineProperty = IsSkipAlpine(packageVersion, packageVersionEntry) ? SkipAlpine : string.Empty;
                    string skipArm64Property = IsSkipArm64(packageVersion, packageVersionEntry) ? SkipArm64 : string.Empty;

                    var properties = targetFrameworkProperty + skipAlpineProperty + skipArm64Property;

                    FileStringBuilder.AppendLine(string.Format(EntryFormat, packageVersionEntry.SampleProjectName, packageVersion, properties, requiresDockerDependency));
                }
            }

            static bool IsSkipAlpine(Version version, PackageVersionEntry entry)
            {
                return entry
                      .VersionConditions
                      .Any(condition => condition.SkipAlpine && AppliesToPackageVersion(version, condition));
            }

            static bool IsSkipArm64(Version version, PackageVersionEntry entry)
            {
                return entry
                      .VersionConditions
                      .Any(condition => condition.SkipArm64 && AppliesToPackageVersion(version, condition));
            }

            static bool AppliesToPackageVersion(Version version, PackageVersionEntry.PackageVersionConditionEntry condition)
            {
                if (!string.IsNullOrEmpty(condition.MinVersion))
                {
                    if (version < new Version(condition.MinVersion))
                    {
                        return false;
                    }
                }

                if (!string.IsNullOrEmpty(condition.MaxVersionExclusive))
                {
                    if (version >= new Version(condition.MaxVersionExclusive))
                    {
                        return false;
                    }
                }

                return true;
            }
        }
    }
}
