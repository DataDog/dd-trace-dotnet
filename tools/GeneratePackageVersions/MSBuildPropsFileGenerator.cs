using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.IO;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace GeneratePackageVersions
{
    public class MSBuildPropsFileGenerator : FileGenerator
    {
        private const string HeaderConst =
@"<!--
***********************************************************************************************
PackageVersions.g.props

NOTE:  This code was generated by the GeneratePackageVersions tool. To safely
       modify this file, edit PackageVersionsGeneratorDefinitions.json and
       re-run the GeneratePackageVersions project in Visual Studio. See the
       launchSettings.json for the project if you would like to run the tool
       with the correct arguments outside of Visual Studio.

***********************************************************************************************
-->
<Project>
  <ItemGroup>";

        private const string FooterConst =
@"  </ItemGroup>
</Project>";

        private const string TargetFrameworkFormat =
@"
      <TargetFramework>{0}</TargetFramework>";

        private const string EntryFormat =
@"    <PackageVersionSample Include=""samples*\**\{0}.csproj"">
      <Properties>ApiVersion={1};RestoreRecursive=false;BuildProjectReferences=false</Properties>{2}
    </PackageVersionSample>";

        public MSBuildPropsFileGenerator(string filename)
            : base(filename)
        {
        }

        protected override string Header
        {
            get
            {
                return HeaderConst;
            }
        }

        protected override string Footer
        {
            get
            {
                return FooterConst;
            }
        }

        public override void Write(PackageVersionEntry packageVersionEntry, IEnumerable<string> netFrameworkPackageVersions, IEnumerable<string> netCorePackageVersions)
        {
            Debug.Assert(Started, "Cannot call Write() before calling Start()");
            Debug.Assert(!Finished, "Cannot call Write() after calling Finish()");

            StringBuilder bodyStringBuilder = new StringBuilder();
            foreach (string packageVersion in netFrameworkPackageVersions)
            {
                string targetFrameworkProperty = string.IsNullOrEmpty(packageVersionEntry.SampleTargetFramework) ? string.Empty : string.Format(TargetFrameworkFormat, packageVersionEntry.SampleTargetFramework);
                FileStringBuilder.AppendLine(string.Format(EntryFormat, packageVersionEntry.SampleProjectName, packageVersion, targetFrameworkProperty));
            }

            foreach (string packageVersion in netCorePackageVersions)
            {
                string targetFrameworkProperty = string.IsNullOrEmpty(packageVersionEntry.SampleTargetFramework) ? string.Empty : string.Format(TargetFrameworkFormat, packageVersionEntry.SampleTargetFramework);
                FileStringBuilder.AppendLine(string.Format(EntryFormat, packageVersionEntry.SampleProjectName, packageVersion, targetFrameworkProperty));
            }
        }
    }
}
