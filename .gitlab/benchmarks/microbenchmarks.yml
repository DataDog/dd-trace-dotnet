stages:
  - benchmarks

run-benchmarks:
  stage: benchmarks
  tags: ["arch:amd64"]
  interruptible: true
  timeout: 1h
  # Image based on earlier version of tooling
  image: registry.ddbuild.io/images/benchmarking-platform-tools-ubuntu:dotnet0

  script:
    - git clone --branch fayssal/migrate-micros-dotnet https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.ddbuild.io/DataDog/benchmarking-platform platform
    - ./platform/launch-instance.sh
    - ./platform/post-pr-comment.sh
    # Temporarely commented out pending issue resolution with sending files to backend
    # - ./platform/steps/upload-to-bp-ui.sh
    
  artifacts:
    name: "artifacts"
    when: always
    paths:
      - artifacts/
    expire_in: 3 months
  rules:
    - when: manual
  variables:
    FF_USE_LEGACY_KUBERNETES_EXECUTION_STRATEGY: "true"
    AWS_REGION: "us-east-1"
    CLEANUP: "false"
    AWS_EPHEMERAL_INFRA_PROFILE_SSM_PARAMETER: "ci.dd-trace-dotnet.ephemeral-infra-ci.dd-trace-dotnet-profile"
    AWS_EPHEMERAL_INFRA_PROFILE_NAME: "ephemeral-infra-ci"
    AWS_EPHEMERAL_INFRA_ARTIFACTS_BUCKET_URI: "s3://windows-benchmarking-results/$CI_PROJECT_NAME/$CI_COMMIT_REF_NAME/$CI_JOB_ID"
    AWS_EPHEMERAL_INFRA_REGION: "us-east-1"