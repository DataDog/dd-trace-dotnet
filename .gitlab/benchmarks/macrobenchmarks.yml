include:
  - project: 'DataDog/benchmarking-platform-tools'
    file: 'images/templates/gitlab/check-slo-breaches.template.yml'
  - project: 'DataDog/benchmarking-platform-tools'
    file: 'images/templates/gitlab/notify-slo-breaches.template.yml'

.dd-octo-sts-setup:
  before_script:
    - |
      set +e
      echo "Attempting to retrieve a GitHub token for scope '$DDOCTOSTS_SCOPE' with policy '$DDOCTOSTS_POLICY' with dd-octo-sts..."
      error_output=$({ dd-octo-sts token --scope $DDOCTOSTS_SCOPE --policy $DDOCTOSTS_POLICY > "/tmp/github-token"; } 2>&1)
      exit_code=$?
      if [ $exit_code -ne 0 ]; then
        echo "Error: Failed to retrieve GitHub token."
        echo "Original error: $error_output"
        echo "Continuing execution anyway..."
      fi
      set -e

stages:
  - build-win
  - check-azure-pipeline
  - benchmarks
  - benchmarks-win
  - gate
  - notify

workflow:
  auto_cancel:
    on_new_commit: interruptible

variables:
  MACROBENCHMARKS_CI_IMAGE: 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/benchmarking-platform:dotnet-throughput-8

check-azure-pipeline:
  stage: check-azure-pipeline
  tags: ["arch:amd64"]
  image: $MACROBENCHMARKS_CI_IMAGE
  rules:
    - if: $CI_COMMIT_REF_NAME == "master"
      interruptible: false
    - interruptible: true
  timeout: 1h
  artifacts:
    name: "artifacts"
    when: always
    paths:
      - platform/artifacts/
      - build-id.txt
    expire_in: 3 months
  variables:
    # Set this for quickly testing benchmarking workflows.
    HARDCODED_BUILD_ID: ""
  script:
    - |
      if [[ -n "$HARDCODED_BUILD_ID" ]]; then
        echo "Using hardcoded build ID $HARDCODED_BUILD_ID"
        echo "export buildId=$HARDCODED_BUILD_ID" > build-id.txt
        exit 0
      fi
    - git clone --branch dd-trace-dotnet/macro https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.ddbuild.io/DataDog/benchmarking-platform platform && cd platform
    - ./wait-for-pipeline.sh


build-dd-trace-dotnet-macrobenchmarks-ami:
  stage: build-win
  tags: ["arch:amd64"]
  image: registry.ddbuild.io/images/benchmarking-platform-tools-ubuntu:dd-trace-dotnet-macro
  allow_failure: true
  when: manual
  timeout: 3h
  variables:
    AWS_REGION: "us-east-1"

    # Branch containing a provision for building the macrobenchmarks AMI
    BP_INFRA_BENCHMARKING_PLATFORM_BRANCH: "dd-trace-dotnet/macro"

    # Whether to cleanup instances after building the AMI, since the AMI is 
    # based on an instance that is created in this job
    CLEANUP: "true"
  script:
    - git clone --branch $BP_INFRA_BENCHMARKING_PLATFORM_BRANCH https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.ddbuild.io/DataDog/benchmarking-platform platform
    - CLEANUP_ARG=$([[ "$CLEANUP" == "false" ]] && echo "--no-cleanup" || echo "")
    - |
      bp-infra launch --region "${AWS_REGION}" --os "windows" \
        --provision ./platform/ephemeral-infra/ami.yaml \
        --bypass-stack-destroy \
        $CLEANUP_ARG
  after_script:
    # Makes sure the instance is cleaned up.
    # Note: This does not clean up the created AMI.
    - |
      if [ "$CLEANUP" == "true" ]; then
        bp-infra cleanup --region "${AWS_REGION}" --os "windows" \
          --provision ./platform/ephemeral-infra/ami.yaml \
          --bypass-stack-destroy
      else
        echo "'CLEANUP' is set to 'false'. Will not cleanup."
      fi

.benchmarks-x86:
  stage: benchmarks
  tags: ["runner:apm-k8s-same-cpu"]
  needs: ["check-azure-pipeline"]
  timeout: 2h
  retry:
    max: 2
    when:
      - unknown_failure
      - data_integrity_failure
      - runner_system_failure
      - scheduler_failure
      - api_failure
      - script_failure
  rules:
    - if: $CI_COMMIT_REF_NAME == "master"
      interruptible: false
    - interruptible: true
  image: $MACROBENCHMARKS_CI_IMAGE
  script:
    - source build-id.txt
    - echo "Building for the following build https://dev.azure.com/datadoghq/dd-trace-dotnet/_build/results?buildId=$buildId&view=results"
    - git clone --branch dd-trace-dotnet/macro https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.ddbuild.io/DataDog/benchmarking-platform platform && cd platform
    - ./steps/setup-sut.sh
    - bp-runner bp-runner.yml --debug
  after_script:
    - mv /var/log/datadog/dotnet/* platform/artifacts
  artifacts:
    name: "artifacts"
    when: always
    paths:
      - platform/artifacts/
    expire_in: 3 months
  variables:
    # k6 configuration, similar to the one in https://grafana.com/docs/k6/latest/using-k6/scenarios/#options
    K6_OPTIONS_WARMUP_DURATION: 3m
    K6_OPTIONS_WARMUP_GRACEFUL_STOP: 10s
    K6_OPTIONS_WARMUP_VUS: 2

    K6_OPTIONS_NORMAL_OPERATION_RATE: 5000
    K6_OPTIONS_NORMAL_OPERATION_DURATION: 10m
    K6_OPTIONS_NORMAL_OPERATION_GRACEFUL_STOP: 10s
    K6_OPTIONS_NORMAL_OPERATION_PRE_ALLOCATED_VUS: 2
    K6_OPTIONS_NORMAL_OPERATION_MAX_VUS: 2

    K6_OPTIONS_HIGH_LOAD_DURATION: 5m
    K6_OPTIONS_HIGH_LOAD_GRACEFUL_STOP: 0s
    K6_OPTIONS_HIGH_LOAD_VUS: 2

    DD_RUNTIME_METRICS_ENABLED: true

baseline-x86:
  extends: .benchmarks-x86
  variables:
    NATIVE_PROFILER_PATH: "dd-trace-dotnet/tracer/tracer-home-linux/linux-x64/Datadog.Trace.ClrProfiler.Native.so"
    TRACER_HOME_PATH: "dd-trace-dotnet/tracer/tracer-home-linux"
    COR_ENABLE_PROFILING: 0
    CORECLR_ENABLE_PROFILING: 0
    ENDPOINT: "hello"

calltarget_ngen-x86:
  extends: .benchmarks-x86
  variables:
    NATIVE_PROFILER_PATH: "dd-trace-dotnet/tracer/tracer-home-linux/linux-x64/Datadog.Trace.ClrProfiler.Native.so"
    TRACER_HOME_PATH: "dd-trace-dotnet/tracer/tracer-home-linux"
    COR_ENABLE_PROFILING: 1
    CORECLR_ENABLE_PROFILING: 1
    DD_CLR_ENABLE_INLINING: 1
    DD_CLR_ENABLE_NGEN: 1
    ENDPOINT: "hello"

single_span-x86:
  extends: .benchmarks-x86
  variables:
    NATIVE_PROFILER_PATH: "dd-trace-dotnet/tracer/tracer-home-linux/linux-x64/Datadog.Trace.ClrProfiler.Native.so"
    TRACER_HOME_PATH: "dd-trace-dotnet/tracer/tracer-home-linux"
    COR_ENABLE_PROFILING: 1
    CORECLR_ENABLE_PROFILING: 1
    DD_CLR_ENABLE_INLINING: 1
    DD_CLR_ENABLE_NGEN: 1
    DD_TRACE_SINGLE_SPAN_ASPNETCORE_ENABLED: 1
    ENDPOINT: "hello"

trace_stats-x86:
  extends: .benchmarks-x86
  variables:
    NATIVE_PROFILER_PATH: "dd-trace-dotnet/tracer/tracer-home-linux/linux-x64/Datadog.Trace.ClrProfiler.Native.so"
    TRACER_HOME_PATH: "dd-trace-dotnet/tracer/tracer-home-linux"
    COR_ENABLE_PROFILING: 1
    CORECLR_ENABLE_PROFILING: 1
    DD_CLR_ENABLE_INLINING: 1
    DD_CLR_ENABLE_NGEN: 1
    DD_TRACE_STATS_COMPUTATION_ENABLED: 1
    ENDPOINT: "hello"

manual_only-x86:
  extends: .benchmarks-x86
  variables:
    NATIVE_PROFILER_PATH: "dd-trace-dotnet/tracer/tracer-home-linux/linux-x64/Datadog.Trace.ClrProfiler.Native.so"
    TRACER_HOME_PATH: "dd-trace-dotnet/tracer/tracer-home-linux"
    COR_ENABLE_PROFILING: 0
    CORECLR_ENABLE_PROFILING: 0
    DOTNET_BUILD_ARGS: "/p:MANUAL_INSTRUMENTATION=true /p:MANUAL_ONLY_INSTRUMENTATION=true"
    ENDPOINT: "hello"

manual_and_automatic-x86:
  extends: .benchmarks-x86
  variables:
    NATIVE_PROFILER_PATH: "dd-trace-dotnet/tracer/tracer-home-linux/linux-x64/Datadog.Trace.ClrProfiler.Native.so"
    TRACER_HOME_PATH: "dd-trace-dotnet/tracer/tracer-home-linux"
    COR_ENABLE_PROFILING: 1
    CORECLR_ENABLE_PROFILING: 1
    DOTNET_BUILD_ARGS: "/p:MANUAL_INSTRUMENTATION=true"
    ENDPOINT: "hello"

ddtraceenabled_false-x86:
  extends: .benchmarks-x86
  variables:
    NATIVE_PROFILER_PATH: "dd-trace-dotnet/tracer/tracer-home-linux/linux-x64/Datadog.Trace.ClrProfiler.Native.so"
    TRACER_HOME_PATH: "dd-trace-dotnet/tracer/tracer-home-linux"
    COR_ENABLE_PROFILING: 1
    CORECLR_ENABLE_PROFILING: 1
    DD_TRACE_ENABLED: 0
    ENDPOINT: "hello"

profiler_exceptions_baseline-x86:
  extends: .benchmarks-x86
  variables:
    NATIVE_PROFILER_PATH: "dd-trace-dotnet/tracer/tracer-home-linux/linux-x64/Datadog.Trace.ClrProfiler.Native.so"
    TRACER_HOME_PATH: "dd-trace-dotnet/tracer/tracer-home-linux"
    COR_ENABLE_PROFILING: 0
    CORECLR_ENABLE_PROFILING: 0
    ENDPOINT: "hello/Exception"

profiler-x86:
  extends: .benchmarks-x86
  variables:
    NATIVE_PROFILER_PATH: "dd-trace-dotnet/tracer/tracer-home-linux/linux-x64/Datadog.Trace.ClrProfiler.Native.so"
    TRACER_HOME_PATH: "dd-trace-dotnet/tracer/tracer-home-linux"
    COR_ENABLE_PROFILING: 1
    CORECLR_ENABLE_PROFILING: 1
    DD_PROFILING_ENABLED: 1
    COMPlus_EnableDiagnostics: 1
    ENDPOINT: "hello"

profiler_walltime-x86:
  extends: .benchmarks-x86
  variables:
    NATIVE_PROFILER_PATH: "dd-trace-dotnet/tracer/tracer-home-linux/linux-x64/Datadog.Trace.ClrProfiler.Native.so"
    TRACER_HOME_PATH: "dd-trace-dotnet/tracer/tracer-home-linux"
    COR_ENABLE_PROFILING: 1
    CORECLR_ENABLE_PROFILING: 1
    DD_PROFILING_ENABLED: 1
    COMPlus_EnableDiagnostics: 1
    DD_PROFILING_WALLTIME_ENABLED: 1
    DD_PROFILING_CPU_ENABLED: 0
    ENDPOINT: "hello"

profiler_exceptions-x86:
  extends: .benchmarks-x86
  variables:
    NATIVE_PROFILER_PATH: "dd-trace-dotnet/tracer/tracer-home-linux/linux-x64/Datadog.Trace.ClrProfiler.Native.so"
    TRACER_HOME_PATH: "dd-trace-dotnet/tracer/tracer-home-linux"
    COR_ENABLE_PROFILING: 1
    CORECLR_ENABLE_PROFILING: 1
    DD_PROFILING_ENABLED: 1
    DD_PROFILING_EXCEPTION_ENABLED: 1
    COMPlus_EnableDiagnostics: 1
    ENDPOINT: "hello/Exception"

profiler_cpu-x86:
  extends: .benchmarks-x86
  variables:
    NATIVE_PROFILER_PATH: "dd-trace-dotnet/tracer/tracer-home-linux/linux-x64/Datadog.Trace.ClrProfiler.Native.so"
    TRACER_HOME_PATH: "dd-trace-dotnet/tracer/tracer-home-linux"
    COR_ENABLE_PROFILING: 1
    CORECLR_ENABLE_PROFILING: 1
    DD_PROFILING_ENABLED: 1
    DD_PROFILING_WALLTIME_ENABLED: 0
    DD_PROFILING_CPU_ENABLED: 1
    COMPlus_EnableDiagnostics: 1
    ENDPOINT: "hello"

profiler_cpu_timer_create-x86:
  extends: .benchmarks-x86
  variables:
    NATIVE_PROFILER_PATH: "dd-trace-dotnet/tracer/tracer-home-linux/linux-x64/Datadog.Trace.ClrProfiler.Native.so"
    TRACER_HOME_PATH: "dd-trace-dotnet/tracer/tracer-home-linux"
    COR_ENABLE_PROFILING: 1
    CORECLR_ENABLE_PROFILING: 1
    DD_PROFILING_ENABLED: 1
    DD_PROFILING_WALLTIME_ENABLED: 0
    DD_PROFILING_CPU_ENABLED: 1
    COMPlus_EnableDiagnostics: 1
    ENDPOINT: "hello"

.benchmarks-arm64:
  stage: benchmarks
  tags: ["runner:apm-k8s-same-cpu"]
  needs: ["check-azure-pipeline"]
  timeout: 2h
  retry:
    max: 2
    when:
      - unknown_failure
      - data_integrity_failure
      - runner_system_failure
      - scheduler_failure
      - api_failure
      - script_failure
  rules:
    - if: $CI_COMMIT_REF_NAME == "master"
      interruptible: false
    - interruptible: true
  image: $MACROBENCHMARKS_CI_IMAGE
  script:
    - source build-id.txt
    - echo "Building for the following build https://dev.azure.com/datadoghq/dd-trace-dotnet/_build/results?buildId=$buildId&view=results"
    - git clone --branch dd-trace-dotnet/macro https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.ddbuild.io/DataDog/benchmarking-platform platform && cd platform
    - ./steps/setup-sut.sh
    - bp-runner bp-runner.arm.yml --debug
  after_script:
    - mv /var/log/datadog/dotnet/* platform/artifacts
  artifacts:
    name: "artifacts"
    when: always
    paths:
      - platform/artifacts/
    expire_in: 3 months
  variables:
    # k6 configuration, similar to the one in https://grafana.com/docs/k6/latest/using-k6/scenarios/#options
    K6_OPTIONS_WARMUP_DURATION: 3m
    K6_OPTIONS_WARMUP_GRACEFUL_STOP: 10s
    K6_OPTIONS_WARMUP_VUS: 2

    K6_OPTIONS_NORMAL_OPERATION_RATE: 4000
    K6_OPTIONS_NORMAL_OPERATION_DURATION: 10m
    K6_OPTIONS_NORMAL_OPERATION_GRACEFUL_STOP: 10s
    K6_OPTIONS_NORMAL_OPERATION_PRE_ALLOCATED_VUS: 2
    K6_OPTIONS_NORMAL_OPERATION_MAX_VUS: 2

    K6_OPTIONS_HIGH_LOAD_DURATION: 5m
    K6_OPTIONS_HIGH_LOAD_GRACEFUL_STOP: 0s
    K6_OPTIONS_HIGH_LOAD_VUS: 2

    DD_RUNTIME_METRICS_ENABLED: true

baseline-arm64:
  extends: .benchmarks-arm64
  tags: ["runner:apm-k8s-arm-metal"]
  variables:
    NATIVE_PROFILER_PATH: "dd-trace-dotnet/tracer/tracer-home-linux-arm64/linux-arm64/Datadog.Trace.ClrProfiler.Native.so"
    TRACER_HOME_PATH: "dd-trace-dotnet/tracer/tracer-home-linux-arm64"
    COR_ENABLE_PROFILING: 0
    CORECLR_ENABLE_PROFILING: 0
    ENDPOINT: "hello"

calltarget_ngen-arm64:
  extends: .benchmarks-arm64
  tags: ["runner:apm-k8s-arm-metal"]
  variables:
    NATIVE_PROFILER_PATH: "dd-trace-dotnet/tracer/tracer-home-linux-arm64/linux-arm64/Datadog.Trace.ClrProfiler.Native.so"
    TRACER_HOME_PATH: "dd-trace-dotnet/tracer/tracer-home-linux-arm64"
    COR_ENABLE_PROFILING: 1
    CORECLR_ENABLE_PROFILING: 1
    DD_CLR_ENABLE_INLINING: 1
    DD_CLR_ENABLE_NGEN: 1
    ENDPOINT: "hello"

single_span-arm64:
  extends: .benchmarks-arm64
  tags: ["runner:apm-k8s-arm-metal"]
  variables:
    NATIVE_PROFILER_PATH: "dd-trace-dotnet/tracer/tracer-home-linux-arm64/linux-arm64/Datadog.Trace.ClrProfiler.Native.so"
    TRACER_HOME_PATH: "dd-trace-dotnet/tracer/tracer-home-linux-arm64"
    COR_ENABLE_PROFILING: 1
    CORECLR_ENABLE_PROFILING: 1
    DD_CLR_ENABLE_INLINING: 1
    DD_CLR_ENABLE_NGEN: 1
    DD_TRACE_SINGLE_SPAN_ASPNETCORE_ENABLED: 1
    ENDPOINT: "hello"

trace_stats-arm64:
  extends: .benchmarks-arm64
  tags: ["runner:apm-k8s-arm-metal"]
  variables:
    NATIVE_PROFILER_PATH: "dd-trace-dotnet/tracer/tracer-home-linux-arm64/linux-arm64/Datadog.Trace.ClrProfiler.Native.so"
    TRACER_HOME_PATH: "dd-trace-dotnet/tracer/tracer-home-linux-arm64"
    COR_ENABLE_PROFILING: 1
    CORECLR_ENABLE_PROFILING: 1
    DD_CLR_ENABLE_INLINING: 1
    DD_CLR_ENABLE_NGEN: 1
    DD_TRACE_STATS_COMPUTATION_ENABLED: 1
    ENDPOINT: "hello"

manual_only-arm64:
  extends: .benchmarks-arm64
  tags: ["runner:apm-k8s-arm-metal"]
  variables:
    NATIVE_PROFILER_PATH: "dd-trace-dotnet/tracer/tracer-home-linux-arm64/linux-arm64/Datadog.Trace.ClrProfiler.Native.so"
    TRACER_HOME_PATH: "dd-trace-dotnet/tracer/tracer-home-linux-arm64"
    COR_ENABLE_PROFILING: 0
    CORECLR_ENABLE_PROFILING: 0
    DOTNET_BUILD_ARGS: "/p:MANUAL_INSTRUMENTATION=true /p:MANUAL_ONLY_INSTRUMENTATION=true"
    ENDPOINT: "hello"

manual_and_automatic-arm64:
  extends: .benchmarks-arm64
  tags: ["runner:apm-k8s-arm-metal"]
  variables:
    NATIVE_PROFILER_PATH: "dd-trace-dotnet/tracer/tracer-home-linux-arm64/linux-arm64/Datadog.Trace.ClrProfiler.Native.so"
    TRACER_HOME_PATH: "dd-trace-dotnet/tracer/tracer-home-linux-arm64"
    COR_ENABLE_PROFILING: 1
    CORECLR_ENABLE_PROFILING: 1
    DOTNET_BUILD_ARGS: "/p:MANUAL_INSTRUMENTATION=true"
    ENDPOINT: "hello"

ddtraceenabled_false-arm64:
  extends: .benchmarks-arm64
  tags: ["runner:apm-k8s-arm-metal"]
  variables:
    NATIVE_PROFILER_PATH: "dd-trace-dotnet/tracer/tracer-home-linux-arm64/linux-arm64/Datadog.Trace.ClrProfiler.Native.so"
    TRACER_HOME_PATH: "dd-trace-dotnet/tracer/tracer-home-linux-arm64"
    COR_ENABLE_PROFILING: 1
    CORECLR_ENABLE_PROFILING: 1
    DD_TRACE_ENABLED: 0
    ENDPOINT: "hello"

profiler_exceptions_baseline-arm64:
  tags: ["runner:apm-k8s-arm-metal"]
  extends: .benchmarks-arm64
  variables:
    NATIVE_PROFILER_PATH: "dd-trace-dotnet/tracer/tracer-home-linux-arm64/linux-arm64/Datadog.Trace.ClrProfiler.Native.so"
    TRACER_HOME_PATH: "dd-trace-dotnet/tracer/tracer-home-linux-arm64"
    COR_ENABLE_PROFILING: 0
    CORECLR_ENABLE_PROFILING: 0
    ENDPOINT: "hello/Exception"

profiler-arm64:
  tags: ["runner:apm-k8s-arm-metal"]
  extends: .benchmarks-arm64
  variables:
    NATIVE_PROFILER_PATH: "dd-trace-dotnet/tracer/tracer-home-linux-arm64/linux-arm64/Datadog.Trace.ClrProfiler.Native.so"
    TRACER_HOME_PATH: "dd-trace-dotnet/tracer/tracer-home-linux-arm64"
    COR_ENABLE_PROFILING: 1
    CORECLR_ENABLE_PROFILING: 1
    DD_PROFILING_ENABLED: 1
    COMPlus_EnableDiagnostics: 1
    ENDPOINT: "hello"

profiler_walltime-arm64:
  tags: ["runner:apm-k8s-arm-metal"]
  extends: .benchmarks-arm64
  variables:
    NATIVE_PROFILER_PATH: "dd-trace-dotnet/tracer/tracer-home-linux-arm64/linux-arm64/Datadog.Trace.ClrProfiler.Native.so"
    TRACER_HOME_PATH: "dd-trace-dotnet/tracer/tracer-home-linux-arm64"
    COR_ENABLE_PROFILING: 1
    CORECLR_ENABLE_PROFILING: 1
    DD_PROFILING_ENABLED: 1
    COMPlus_EnableDiagnostics: 1
    DD_PROFILING_WALLTIME_ENABLED: 1
    DD_PROFILING_CPU_ENABLED: 0
    ENDPOINT: "hello"

profiler_exceptions-arm64:
  tags: ["runner:apm-k8s-arm-metal"]
  extends: .benchmarks-arm64
  variables:
    NATIVE_PROFILER_PATH: "dd-trace-dotnet/tracer/tracer-home-linux-arm64/linux-arm64/Datadog.Trace.ClrProfiler.Native.so"
    TRACER_HOME_PATH: "dd-trace-dotnet/tracer/tracer-home-linux-arm64"
    COR_ENABLE_PROFILING: 1
    CORECLR_ENABLE_PROFILING: 1
    DD_PROFILING_ENABLED: 1
    DD_PROFILING_EXCEPTION_ENABLED: 1
    COMPlus_EnableDiagnostics: 1
    ENDPOINT: "hello/Exception"

profiler_cpu-arm64:
  tags: ["runner:apm-k8s-arm-metal"]
  extends: .benchmarks-arm64
  variables:
    NATIVE_PROFILER_PATH: "dd-trace-dotnet/tracer/tracer-home-linux-arm64/linux-arm64/Datadog.Trace.ClrProfiler.Native.so"
    TRACER_HOME_PATH: "dd-trace-dotnet/tracer/tracer-home-linux-arm64"
    COR_ENABLE_PROFILING: 1
    CORECLR_ENABLE_PROFILING: 1
    DD_PROFILING_ENABLED: 1
    DD_PROFILING_WALLTIME_ENABLED: 0
    DD_PROFILING_CPU_ENABLED: 1
    COMPlus_EnableDiagnostics: 1
    ENDPOINT: "hello"

profiler_cpu_timer_create-arm64:
  tags: ["runner:apm-k8s-arm-metal"]
  extends: .benchmarks-arm64
  variables:
    NATIVE_PROFILER_PATH: "dd-trace-dotnet/tracer/tracer-home-linux-arm64/linux-arm64/Datadog.Trace.ClrProfiler.Native.so"
    TRACER_HOME_PATH: "dd-trace-dotnet/tracer/tracer-home-linux-arm64"
    COR_ENABLE_PROFILING: 1
    CORECLR_ENABLE_PROFILING: 1
    DD_PROFILING_ENABLED: 1
    DD_PROFILING_WALLTIME_ENABLED: 0
    DD_PROFILING_CPU_ENABLED: 1
    COMPlus_EnableDiagnostics: 1
    ENDPOINT: "hello"

.benchmarks-win:
  stage: benchmarks-win
  needs: ["check-azure-pipeline"]
  tags: ["arch:amd64"]
  image: registry.ddbuild.io/images/benchmarking-platform-tools-ubuntu:dd-trace-dotnet-macro
  id_tokens:
    DDOCTOSTS_ID_TOKEN:
      aud: dd-octo-sts
  retry:
    max: 2
    when:
      - unknown_failure
      - data_integrity_failure
      - runner_system_failure
      - scheduler_failure
      - api_failure
      - script_failure
  rules:
    - if: $CI_COMMIT_REF_NAME == "master"
      interruptible: false
    - interruptible: true
  timeout: 2h
  artifacts:
    name: "artifacts"
    when: always
    paths:
      - reports/
    expire_in: 3 months
  variables:
    RUNNER_AFTER_SCRIPT_TIMEOUT: 1h

    # Allows ephemeral instances to read content from benchmarking-platform
    DDOCTOSTS_SCOPE: "DataDog/benchmarking-platform"
    DDOCTOSTS_POLICY: "gitlab.github-access.read-contents"

    AWS_REGION: "us-east-1"

    # Branch containing 1. scripts to launch Windows benchmarks on ephemeral 
    # instances (to be used by GitLab CI runners) and 2. scripts to run Windows 
    # benchmarks (to be used by the ephemeral instances).
    BP_INFRA_BENCHMARKING_PLATFORM_BRANCH: "dd-trace-dotnet/macro"

    # Where benchmarking results will be stored
    BP_INFRA_ARTIFACTS_BUCKET_NAME: "windows-benchmarking-results-us-east-1"

    # Whether to mock benchmark execution. Useful for testing the after_script steps
    BP_INFRA_TEST: "false"

    # Whether to cleanup ephemeral instances after benchmarks are run
    CLEANUP: "true"

    ARTIFACTS_DIR: "reports"

    # k6 configuration, similar to the one in https://grafana.com/docs/k6/latest/using-k6/scenarios/#options
    K6_OPTIONS_WARMUP_DURATION: 3m
    K6_OPTIONS_WARMUP_GRACEFUL_STOP: 10s
    K6_OPTIONS_WARMUP_VUS: 2

    K6_OPTIONS_NORMAL_OPERATION_RATE: 13000
    K6_OPTIONS_NORMAL_OPERATION_DURATION: 10m
    K6_OPTIONS_NORMAL_OPERATION_GRACEFUL_STOP: 10s
    K6_OPTIONS_NORMAL_OPERATION_PRE_ALLOCATED_VUS: 500
    K6_OPTIONS_NORMAL_OPERATION_MAX_VUS: 2000

    K6_OPTIONS_HIGH_LOAD_DURATION: 5m
    K6_OPTIONS_HIGH_LOAD_GRACEFUL_STOP: 0s
    K6_OPTIONS_HIGH_LOAD_VUS: 2

    DD_RUNTIME_METRICS_ENABLED: true
  before_script:
    - !reference [.dd-octo-sts-setup, before_script]
  script:
    - source build-id.txt
    - echo "Running Windows benchmarks for build https://dev.azure.com/datadoghq/dd-trace-dotnet/_build/results?buildId=$buildId&view=results"
    - export GITHUB_TOKEN=$(cat /tmp/github-token)
    - git clone --branch $BP_INFRA_BENCHMARKING_PLATFORM_BRANCH https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.ddbuild.io/DataDog/benchmarking-platform platform
    - ./platform/steps/run-windows-benchmarks.sh
    - ./platform/steps/fetch-results.sh
  after_script:
    - |
      if [ "$CLEANUP" == "true" ]; then
        bp-infra cleanup --provision ./platform/ephemeral-infra/instance.yaml \
          --region "${AWS_REGION}" \
          --bypass-stack-destroy
      else
        echo "'CLEANUP' is set to 'false'. Will not cleanup."
      fi
    - ./platform/steps/fetch-windows-results.sh
    - ./platform/steps/upload-windows-results-to-bp-ui.sh

baseline-win:
  extends: .benchmarks-win
  variables:
    ENDPOINT: "hello"

calltarget_ngen-win:
  extends: .benchmarks-win
  variables:
    COR_ENABLE_PROFILING: 1
    CORECLR_ENABLE_PROFILING: 1
    DD_CLR_ENABLE_INLINING: 1
    DD_CLR_ENABLE_NGEN: 1
    ENDPOINT: "hello"

single_span-win:
  extends: .benchmarks-win
  variables:
    COR_ENABLE_PROFILING: 1
    CORECLR_ENABLE_PROFILING: 1
    DD_CLR_ENABLE_INLINING: 1
    DD_CLR_ENABLE_NGEN: 1
    DD_TRACE_SINGLE_SPAN_ASPNETCORE_ENABLED: 1
    ENDPOINT: "hello"

trace_stats-win:
  extends: .benchmarks-win
  variables:
    COR_ENABLE_PROFILING: 1
    CORECLR_ENABLE_PROFILING: 1
    DD_CLR_ENABLE_INLINING: 1
    DD_CLR_ENABLE_NGEN: 1
    DD_TRACE_STATS_COMPUTATION_ENABLED: 1
    ENDPOINT: "hello"

manual_only-win:
  extends: .benchmarks-win
  variables:
    COR_ENABLE_PROFILING: 0
    CORECLR_ENABLE_PROFILING: 0
    DOTNET_BUILD_ARGS: "/p:MANUAL_INSTRUMENTATION=true /p:MANUAL_ONLY_INSTRUMENTATION=true"
    ENDPOINT: "hello"

manual_and_automatic-win:
  extends: .benchmarks-win
  variables:
    COR_ENABLE_PROFILING: 1
    CORECLR_ENABLE_PROFILING: 1
    DOTNET_BUILD_ARGS: "/p:MANUAL_INSTRUMENTATION=true"
    ENDPOINT: "hello"

ddtraceenabled_false-win:
  extends: .benchmarks-win
  variables:
    COR_ENABLE_PROFILING: 1
    CORECLR_ENABLE_PROFILING: 1
    DD_TRACE_ENABLED: 0
    ENDPOINT: "hello"

profiler_exceptions_baseline-win:
  extends: .benchmarks-win
  variables:
    COR_ENABLE_PROFILING: 0
    CORECLR_ENABLE_PROFILING: 0
    ENDPOINT: "hello/Exception"

profiler-win:
  extends: .benchmarks-win
  variables:
    COR_ENABLE_PROFILING: 1
    CORECLR_ENABLE_PROFILING: 1
    DD_PROFILING_ENABLED: 1
    COMPlus_EnableDiagnostics: 1
    ENDPOINT: "hello"

profiler_walltime-win:
  extends: .benchmarks-win
  variables:
    COR_ENABLE_PROFILING: 1
    CORECLR_ENABLE_PROFILING: 1
    DD_PROFILING_ENABLED: 1
    COMPlus_EnableDiagnostics: 1
    DD_PROFILING_WALLTIME_ENABLED: 1
    DD_PROFILING_CPU_ENABLED: 0
    ENDPOINT: "hello"

profiler_exceptions-win:
  extends: .benchmarks-win
  variables:
    COR_ENABLE_PROFILING: 1
    CORECLR_ENABLE_PROFILING: 1
    DD_PROFILING_ENABLED: 1
    DD_PROFILING_EXCEPTION_ENABLED: 1
    COMPlus_EnableDiagnostics: 1
    ENDPOINT: "hello/Exception"

profiler_cpu-win:
  extends: .benchmarks-win
  variables:
    COR_ENABLE_PROFILING: 1
    CORECLR_ENABLE_PROFILING: 1
    DD_PROFILING_ENABLED: 1
    DD_PROFILING_WALLTIME_ENABLED: 0
    DD_PROFILING_CPU_ENABLED: 1
    COMPlus_EnableDiagnostics: 1
    ENDPOINT: "hello"

profiler_cpu_timer_create-win:
  extends: .benchmarks-win
  variables:
    COR_ENABLE_PROFILING: 1
    CORECLR_ENABLE_PROFILING: 1
    DD_PROFILING_ENABLED: 1
    DD_PROFILING_WALLTIME_ENABLED: 0
    DD_PROFILING_CPU_ENABLED: 1
    COMPlus_EnableDiagnostics: 1
    ENDPOINT: "hello"

check-slo-breaches:
  extends: .check-slo-breaches
  stage: gate
  needs:
    - baseline-win
    - calltarget_ngen-win
    - single_span-win
    - trace_stats-win
    - manual_only-win
    - manual_and_automatic-win
    - ddtraceenabled_false-win
    - profiler_exceptions_baseline-win
    - profiler-win
    - profiler_walltime-win
    - profiler_exceptions-win
    - profiler_cpu-win
    - profiler_cpu_timer_create-win
  when: always
  allow_failure: true # Allowed to fail since we don't want it to block releases yet
  variables:
    ARTIFACTS_DIR: "reports"

notify-slo-breaches:
  extends: .notify-slo-breaches
  stage: notify
  needs: ["check-slo-breaches"]
  when: always
  allow_failure: true
  variables:
    CHANNEL: "apm-dotnet-bots"
    ARTIFACTS_DIR: "reports"

