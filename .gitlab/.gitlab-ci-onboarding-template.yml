
stages:
  - package
  - publish
  - release

include:
  - remote: https://gitlab-templates.ddbuild.io/apm/packaging.yml

variables:
  GIT_PROFILER_REF: master
  DOTNET_PACKAGE_VERSION_DEV: 
   description: "Used by the package stage when triggered manually"

test_echo:
  stage: package
  image: registry.ddbuild.io/images/ci_docker_base
  tags: ["runner:docker"]
  script:
    - echo "Hello, world-----> $DOTNET_PACKAGE_VERSION"
    - echo "Hello, world dev -----> $DOTNET_PACKAGE_VERSION_DEV"
  env:
    DOTNET_PACKAGE_VERSION: $DOTNET_PACKAGE_VERSION_DEV

package-dev:
  extends: .package
  rules:
    - if: $DOTNET_PACKAGE_VERSION
      when: on_success
    - if: '$CI_COMMIT_TAG =~ /^v[0-9]+\.[0-9]+\.[0-9]+(-prerelease)?$/'
      when: manual
      allow_failure: false
  script:
    - ../.gitlab/build-deb-rpm.sh
  variables:
    ARCH: amd64

package-arm-dev:
  extends: .package-arm
  rules:
    - if: $DOTNET_PACKAGE_VERSION
      when: on_success
    - if: '$CI_COMMIT_TAG =~ /^v[0-9]+\.[0-9]+\.[0-9]+(-prerelease)?$/'
      when: manual
      allow_failure: false
  script:
    - ../.gitlab/build-deb-rpm.sh
  variables:
    ARCH: arm64

package-oci-dev:
  stage: package
  extends: .package-oci
  rules:
    - if: $DOTNET_PACKAGE_VERSION
      when: on_success
    - if: '$CI_COMMIT_TAG =~ /^v[0-9]+\.[0-9]+\.[0-9]+(-prerelease)?$/'
      when: manual
      allow_failure: false
  script:
    - ../.gitlab/build-oci.sh
  parallel:
    matrix:
      - ARCH:
        - arm64
        - amd64

