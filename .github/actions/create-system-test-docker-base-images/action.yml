name: 'Build System-test base images'
description: 'Builds the system-test docker base images'

inputs:
  artifacts_path:
    description: 'The location of the assets to use in the current workflow'
    required: true

  package_version:
    description: 'The package version of the assets being used'
    required: true

  lib_waf_version:
    description: 'The version of the WAF being used'
    required: false

  waf_rules_version:
    description: 'The version of the rules being used'
    required: false

  github_token:
    description: 'Github token for pushing images to ghcr.io Docker repository'
    required: true

  commit_sha:
    description: 'Identifier of the commit that triggered the package generation'
    required: false

  is_tracer_package:
    description: 'True if we are creating the docker base image for the tracer. otherwise, false, create docker base image for linux packages'
    required: true

runs:
  using: "composite"
  steps:

    - name: Copy tooling files to artifacts path
      shell: bash
      run: |
        echo "OUTPUT ARTIFACT PATH: ${{inputs.artifacts_path}}"
        cp ./tracer/build/_build/docker/system-tests.dockerfile ${{inputs.artifacts_path}}
        cp ./tracer/build/_build/docker/system-tests-linux.dockerfile ${{inputs.artifacts_path}}

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v2

    - name: Set up Docker Buildx
      id: buildx
      uses: docker/setup-buildx-action@v2

    - name: Login to Docker
      shell: bash
      run: docker login -u publisher -p ${{ inputs.github_token }} ghcr.io

    - name: Docker Build tracer linux-x64 and linux-arm64 images
      uses: docker/build-push-action@v3
      if: ${{ inputs.is_tracer_package == "True" }}
      with:
        push: true
        tags: ghcr.io/datadog/dd-trace-dotnet/dd-trace-dotnet:latest_snapshot
        platforms: 'linux/amd64,linux/arm64'
        context: ${{inputs.artifacts_path}}
        file: ${{inputs.artifacts_path}}/system-tests.dockerfile
        build-args: |
          LINUX_AMD64_PACKAGE=datadog-dotnet-apm-${{inputs.package_version}}.tar.gz
          LINUX_ARM64_PACKAGE=datadog-dotnet-apm-${{inputs.package_version}}.arm64.tar.gz
          LIBRARY_VERSION=${{inputs.package_version}}
          LIBDDWAF_VERSION=${{inputs.lib_waf_version}}
          APPSEC_EVENT_RULES_VERSION=${{inputs.waf_rules_version}}

    - name: Docker Build docker base images for deb and rpm packages
      uses: docker/build-push-action@v3
      if: ${{ inputs.is_tracer_package == "False" }}
      with:
        push: true
        tags: ghcr.io/datadog/dd-trace-dotnet/apm-library-dotnet:${{inputs.commit_sha}}
        platforms: 'linux/amd64'
        context: ${{inputs.artifacts_path}}
        file: ${{inputs.artifacts_path}}/system-tests-linux.dockerfile
        build-args: |
          PACKAGE_VERSION=${{inputs.package_version}}