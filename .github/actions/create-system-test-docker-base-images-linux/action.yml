name: 'Build System-test linux base images'
description: 'Builds the system-test linux docker base images: datadog-apm-library-dotnet'

inputs:
  artifacts_path:
    description: 'The location of the assets to use in the current workflow'
    required: true

  package_version:
    description: 'The package version of the assets being used'
    required: true

  commit_sha:
    description: 'Identifier of the commit that triggered the package generation'
    required: true

  github_token:
    description: 'Github token for pushing images to ghcr.io Docker repository'
    required: true

runs:
  using: "composite"
  steps:

    - name: Copy tooling files to artifacts path
      shell: bash
      run: |
        echo "OUTPUT ARTIFACT PATH: ${{inputs.artifacts_path}}"
        cp ./tracer/build/_build/docker/system-tests-linux.dockerfile ${{inputs.artifacts_path}}

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v2

    - name: Set up Docker Buildx
      id: buildx
      uses: docker/setup-buildx-action@v2

    - name: Login to Docker
      shell: bash
      run: docker login -u publisher -p ${{ inputs.github_token }} ghcr.io

    - name: Docker Build linux-x64 and linux-arm64 images
      uses: docker/build-push-action@v3
      with:
        push: true
        tags: ghcr.io/datadog/dd-trace-dotnet/apm-library-dotnet:${{inputs.commit_sha}}
        platforms: 'linux/amd64'
        context: ${{inputs.artifacts_path}}
        file: ${{inputs.artifacts_path}}/system-tests-linux.dockerfile
        build-args: |
          PACKAGE_VERSION=${{inputs.package_version}}
