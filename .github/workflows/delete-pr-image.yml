name: "Delete Docker image on PR close"

on:
  pull_request:
    types: [closed]

jobs:
  delete-pr-image:
    # Only run for PRs that had the docker_image_artifacts label
    if: contains(github.event.pull_request.labels.*.name, 'docker_image_artifacts')
    runs-on: ubuntu-latest
    permissions:
      packages: write   # required to delete GHCR container versions
      contents: read

    steps:
      - name: Sanitize branch name to match image tag
        id: sanitize
        run: |
          BRANCH="${{ github.event.pull_request.head.ref }}"
          TAG="${BRANCH//\//_}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - name: Delete image from GHCR
        uses: actions/delete-package-versions@e5bc658cc4c965c472efe991f8beea3981499c55
        with:
          package-name: 'dd-trace-dotnet/dd-trace-dotnet'
          package-type: 'container'
          token: ${{ secrets.GITHUB_TOKEN }}
          version-pattern: '^${{ steps.sanitize.outputs.tag }}$' 