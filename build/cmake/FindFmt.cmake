include(ExternalProject)

SET(FMT_VERSION "5.3.0")

if (ISMACOS)
	SET(FMT_CXXFLAGS "-target\ ${OSX_ARCH}-apple-darwin${CMAKE_HOST_SYSTEM_VERSION}\ -D_GLIBCXX_USE_CXX11_ABI=0")
elseif(ISLINUX)
	SET(FMT_CXXFLAGS "-D_GLIBCXX_USE_CXX11_ABI=0")
endif()

ExternalProject_Add(fmt
    DOWNLOAD_COMMAND ${CMAKE_COMMAND} -DPROJECT_NAME=fmt -DPROJECT_REPOSITORY=https://github.com/DataDog/fmt.git -DPROJECT_BRANCH=${FMT_VERSION} -P ${CMAKE_SOURCE_DIR}/build/cmake/git-clone-quiet-once.cmake
    UPDATE_COMMAND ""
    TIMEOUT 5
    INSTALL_COMMAND ""
    BUILD_IN_SOURCE TRUE
    CMAKE_ARGS -DCMAKE_POSITION_INDEPENDENT_CODE=TRUE -DFMT_TEST=0 -DFMT_DOC=0
    BUILD_COMMAND ${CMAKE_COMMAND} -E env CXXFLAGS=${FMT_CXXFLAGS} make -j
    BUILD_BYPRODUCTS ${CMAKE_CURRENT_BINARY_DIR}/fmt-prefix/src/fmt/libfmt.a
)

ExternalProject_Get_property(fmt SOURCE_DIR)

get_property(FOLDERS_TO_DELETE DIRECTORY PROPERTY ADDITIONAL_MAKE_CLEAN_FILES)
set_property(DIRECTORY PROPERTY ADDITIONAL_MAKE_CLEAN_FILES "${FOLDERS_TO_DELETE};${CMAKE_BINARY_DIR}/fmt-prefix/src/fmt/")

add_library(fmt-lib STATIC IMPORTED)

set_target_properties(fmt-lib PROPERTIES
    INCLUDE_DIRECTORIES ${CMAKE_CURRENT_BINARY_DIR}/fmt-prefix/src/fmt/include
    IMPORTED_LOCATION ${CMAKE_CURRENT_BINARY_DIR}/fmt-prefix/src/fmt/libfmt.a
)

add_dependencies(fmt-lib fmt)
