<?xml version="1.0" encoding="UTF-8"?>

<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi"
     xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">
  <?include $(sys.CURRENTDIR)\Config.wxi?>
  <Fragment>

    <?if $(var.Win64) = yes ?>
    <ComponentGroup Id="Shared.Files" Directory="INSTALLFOLDER">
      <Component Win64="yes">
        <File Id="loader.conf" Source="$(var.MonitoringHomeDirectory)\win-x64\loader.conf" />
      </Component>
    </ComponentGroup>
    
    <ComponentGroup Id="Shared.Files.NativeLoader.64" Directory="INSTALLFOLDER">
      <Component Win64="yes">
        <File Id="Datadog.Trace.ClrProfiler.Native.x64.dll"
              Source="$(var.MonitoringHomeDirectory)\win-x64\Datadog.Trace.ClrProfiler.Native.dll"
              Checksum="yes">
          <Class Id="$(var.ProfilerCLSID)" Context="InprocServer32" ThreadingModel="both" Description="$(var.ProductNamePlatformAgnostic)"/>
        </File>

      </Component>
      <Component Win64="yes">
        <File Id="Datadog.Trace.ClrProfiler.Native.x64.pdb"
              Source="$(var.MonitoringHomeDirectory)\win-x64\Datadog.Trace.ClrProfiler.Native.pdb"
              Checksum="yes">
        </File>
      </Component>
    </ComponentGroup>

    <!-- For the 64-bit installer, also install the 32-bit binaries -->
    <ComponentGroup Id="Shared.Files.NativeLoader.32" Directory="INSTALLFOLDER.32">
      <Component Win64="no" Id="Datadog.Trace.ClrProfiler.Native.x86.dll">
        <File Id="Datadog.Trace.ClrProfiler.Native.x86.dll"
              Source="$(var.MonitoringHomeDirectory)\win-x86\Datadog.Trace.ClrProfiler.Native.dll"
              Checksum="yes">
          <Class Id="$(var.ProfilerCLSID)" Context="InprocServer32" ThreadingModel="both" Description="$(var.ProductNamePlatformAgnostic)"/>
        </File>
      </Component>
      <Component Win64="no">
        <File Id="Datadog.Trace.ClrProfiler.Native.x86.pdb"
              Source="$(var.MonitoringHomeDirectory)\win-x86\Datadog.Trace.ClrProfiler.Native.pdb"
              Checksum="yes">
        </File>
      </Component>
    </ComponentGroup>

    <?else ?>
    <ComponentGroup Id="Shared.Files" Directory="INSTALLFOLDER">
      <Component Win64="no">
        <File Id="loader.conf" Source="$(var.MonitoringHomeDirectory)\win-x86\loader.conf" />
      </Component>
    </ComponentGroup>

    <!-- note that for the 32-bit build, we need to install into INSTALLFOLDER instead of INSTALLFOLDER.32 -->
    <ComponentGroup Id="Shared.Files.NativeLoader.32" Directory="INSTALLFOLDER">
      <Component Win64="no">
        <File Id="Datadog.Trace.ClrProfiler.Native.x86.dll"
              Source="$(var.MonitoringHomeDirectory)\win-x86\Datadog.Trace.ClrProfiler.Native.dll"
              Checksum="yes">
          <Class Id="$(var.ProfilerCLSID)" Context="InprocServer32" ThreadingModel="both" Description="$(var.ProductNamePlatformAgnostic)"/>
        </File>
      </Component>
      <Component Win64="no">
        <File Id="Datadog.Trace.ClrProfiler.Native.x86.pdb"
              Source="$(var.MonitoringHomeDirectory)\Datadog.Trace.ClrProfiler.Native.pdb"
              Checksum="yes">
        </File>
      </Component>
    </ComponentGroup>

    <?endif ?>
  </Fragment>
</Wix>
