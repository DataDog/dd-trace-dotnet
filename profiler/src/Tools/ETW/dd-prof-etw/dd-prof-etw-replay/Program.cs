// <copyright file="Program.cs" company="Datadog">
// Unless explicitly stated otherwise all files in this repository are licensed under the Apache 2 License.
// This product includes software developed at Datadog (https://www.datadoghq.com/). Copyright 2022 Datadog, Inc.
// </copyright>

using System;
using System.IO;

namespace Datadog.Profiler.IntegrationTests
{
    internal class Program
    {
        // This application reads a .bevents file and dumps the records and events
        // It is used to validate the .bevents file generated by the dd-prof-etw-client tool
        private static void Main(string[] args)
        {
            try
            {
                ParseCommandLine(args, out string eventsFilename);
                if (eventsFilename == null)
                {
                    throw new ArgumentException("Missing required argument: -f <.bevents file name>");
                }

                Console.WriteLine($"Processing events in {eventsFilename}");

                using (FileStream fs = new FileStream(eventsFilename, FileMode.Open, FileAccess.Read))
                using (BinaryReader reader = new BinaryReader(fs))
                {
                    var recordDumper = new RecordDumper();
                    var eventDumper = new EventDumper();
                    var recordReader = new RecordReader(reader, recordDumper, eventDumper);
                    int count = 0;
                    while (fs.Position < fs.Length)
                    {
                        var current = ++count;
                        //Console.Write($"#{current,6} ");
                        recordReader.ReadRecord();
                    }

                    Console.WriteLine($"Total = {count} records");
                }
            }
            catch (Exception x)
            {
                Console.WriteLine("Replay recorded ETW events");
                Console.WriteLine("  -f <.bevents file name>");
                Console.WriteLine("----------------------------------------------------");
                Console.WriteLine($"Error: {x.Message}");
            }
        }

        private static void ParseCommandLine(string[] args, out string eventsFilename)
        {
            eventsFilename = null;

            for (int i = 0; i < args.Length; i++)
            {
                string arg = args[i];
                if ("-f".Equals(arg, StringComparison.OrdinalIgnoreCase))
                {
                    // a filename is expected
                    i++;
                    if (i < args.Length)
                    {
                        eventsFilename = args[i];
                    }
                }
            }
        }
    }
}
