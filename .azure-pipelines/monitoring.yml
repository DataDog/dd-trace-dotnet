trigger: none
pr: none

variables:
  ddApiKey: $(DD_API_KEY)

resources:
  pipelines:
  - pipeline: consolidated-pipeline
    source: consolidated-pipeline
    trigger: true # Run when any run of consolidated-pipeline completes

  containers:
  - container: dd_agent
    image: datadog/agent
    ports:
    - 8126:8126
    env:
      DD_API_KEY: $(ddApiKey)
      DD_INSIDE_CI: true

# Enable the Datadog Agent service for this job
services:
  dd_agent: dd_agent

steps:

- bash: dotnet build
  displayName: "Build"
  workingDirectory: "$(Build.SourcesDirectory)/tracer/tools/PipelineMonitor"


- bash: dotnet run $(resources.pipeline.consolidated-pipeline.runID)
  displayName: "Run"
  workingDirectory: "$(Build.SourcesDirectory)/tracer/tools/PipelineMonitor"

- bash: sleep 20
  displayName: Wait 20 seconds to agent flush before finishing pipeline